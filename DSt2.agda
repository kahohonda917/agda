module DSt2 where

open import Data.Nat
open import Data.Bool using (true; false) renaming (Bool to ğ”¹)
open import Data.Empty
open import Data.Product
open import Function
open import Relation.Nullary
open import Data.Unit using (âŠ¤; tt)
open import Relation.Binary.PropositionalEquality

infixr 5 _â‡’_âŸ¨_âŸ©_âŸ¨_âŸ©_

mutual
  data typ : Set where
    Nat : typ
    Tbool : typ
    _â‡’_âŸ¨_âŸ©_âŸ¨_âŸ©_ : {Î¼Î± Î¼Î² : trail} â†’
                  (Ï„â‚‚ Ï„â‚ : typ) â†’ (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ (Î± : typ) â†’
                  (Î¼Î² : trail) â†’ (Î² : typ) â†’ typ

  data trail : Set where
    âˆ™ : trail
    _â‡’_,_ : (Ï„ Ï„' : typ) â†’ (Î¼ : trail) â†’ trail

  data trails[_]_ (Î¼Î± : trail) : trail â†’ Set where
    [] : trails[ Î¼Î± ] Î¼Î±
    _::âŸ¨_âŸ©_ : {Ï„â‚ Ï„â‚‚ : typ} {Î¼ Î¼Î² Î¼Î³ : trail} â†’
              (Î¼k : trail) â†’ (c : compatible Î¼k Î¼Î² Î¼Î³) â†’
              (Î¼s : trails[ Î¼Î± ] Î¼Î²) â†’
              trails[ Î¼Î± ] Î¼Î³

  compatible : (Î¼â‚ Î¼â‚‚ Î¼â‚ƒ : trail) â†’ Set
  compatible âˆ™ Î¼â‚‚ Î¼â‚ƒ = Î¼â‚‚ â‰¡ Î¼â‚ƒ
  compatible (Ï„â‚ â‡’ Ï„â‚' , Î¼â‚) âˆ™ Î¼â‚ƒ = (Ï„â‚ â‡’ Ï„â‚' , Î¼â‚) â‰¡ Î¼â‚ƒ
  compatible (Ï„â‚ â‡’ Ï„â‚' , Î¼â‚) (Ï„â‚‚ â‡’ Ï„â‚‚' , Î¼â‚‚) âˆ™ = âŠ¥
  compatible (Ï„â‚ â‡’ Ï„â‚' , Î¼â‚) (Ï„â‚‚ â‡’ Ï„â‚‚' , Î¼â‚‚) (Ï„â‚ƒ â‡’ Ï„â‚ƒ' , Î¼â‚ƒ) =
             (Ï„â‚ â‰¡ Ï„â‚ƒ) Ã— (Ï„â‚' â‰¡ Ï„â‚ƒ') Ã—
             (compatible (Ï„â‚‚ â‡’ Ï„â‚‚' , Î¼â‚‚) Î¼â‚ƒ Î¼â‚)

compatible-equal : {Î¼â‚ Î¼â‚‚ Î¼â‚ƒ : trail} â†’
                   (câ‚ câ‚‚ : compatible Î¼â‚ Î¼â‚‚ Î¼â‚ƒ) â†’ câ‚ â‰¡ câ‚‚
compatible-equal {âˆ™} refl refl = refl
compatible-equal {Ï„â‚ â‡’ Ï„â‚' , Î¼â‚} {âˆ™} refl refl = refl
compatible-equal {Ï„â‚ â‡’ Ï„â‚' , Î¼â‚} {Ï„â‚‚ â‡’ Ï„â‚‚' , Î¼â‚‚} {.Ï„â‚ â‡’ .Ï„â‚' , Î¼â‚ƒ}
                 (refl , refl , câ‚) (refl , refl , câ‚‚)
  rewrite compatible-equal câ‚ câ‚‚ = refl

is-id-trail : (Ï„ Ï„' : typ) â†’ (Î¼ : trail) â†’ Set
is-id-trail Ï„ Ï„' âˆ™ = Ï„ â‰¡ Ï„'
is-id-trail Ï„ Ï„' (Ï„â‚ â‡’ Ï„â‚' , Î¼) = (Ï„ â‰¡ Ï„â‚) Ã— (Ï„' â‰¡ Ï„â‚') Ã— (Î¼ â‰¡ âˆ™)

is-id-trails : {Î¼Î± : trail} (Ï„ Ï„' : typ) â†’ (Î¼s : trails[ âˆ™ ] Î¼Î±) â†’ Set
is-id-trails {Î¼Î±} Ï„ Ï„' Î¼s = is-id-trail Ï„ Ï„' Î¼Î±

-- source term
mutual
  data value[_]_ (var : typ â†’ Set) : (Ï„ : typ) â†’ Set where
    Var : {Ï„â‚ : typ} â†’ var Ï„â‚ â†’ value[ var ] Ï„â‚
    Num : (n : â„•) â†’ value[ var ] Nat
    Fun : {Ï„â‚ Ï„â‚‚ Î± Î² : typ} {Î¼Î± Î¼Î² : trail} {Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
          (eâ‚ : var Ï„â‚‚ â†’ term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)

  data term[_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : typ â†’ Set) : (Ï„ : typ) {Î¼Î± Î¼Î² : trail} â†’
          (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ (Î± : typ) â†’ (Î¼Î² : trail) â†’ (Î² : typ) â†’
          Set where
    Val : {Ï„â‚ Î± : typ} {Î¼Î± : trail} â†’
          (v : value[ var ] Ï„â‚) â†’ term[ var ] Ï„â‚ âŸ¨ []{Î¼Î±} âŸ© Î± âŸ¨ Î¼Î± âŸ© Î±
    App : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
          {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
          {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
          {Î¼[Î´]Î³ : trails[ Î¼Î´ ] Î¼Î³} â†’
          {Î¼[Î´]Î± : trails[ Î¼Î´ ] Î¼Î±} â†’
          (eâ‚ : term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)
                            âŸ¨ Î¼[Î´]Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´) â†’
          (eâ‚‚ : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
          term[ var ] Ï„â‚ âŸ¨ Î¼[Î´]Î± âŸ© Î± âŸ¨ Î¼Î´ âŸ© Î´
    Plus : {Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
           {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
           {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
           {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
           (eâ‚ : term[ var ] Nat âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
           (eâ‚‚ : term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
           term[ var ] Nat âŸ¨ Î¼[Î³]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³
    Control : {Ï„ Î± Î² Î³ Î³' tâ‚ tâ‚‚ : typ} {Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² : trail}
              {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
              {Î¼sâ‚ : trails[ Î¼â‚‚ ] Î¼â‚} â†’
              {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
              (id : is-id-trails Î³ Î³' Î¼sáµ¢) â†’
              (câ‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€) â†’
              (câ‚‚ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
              (e : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
                   term[ var ] Î³ âŸ¨ Î¼sáµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²) â†’
              term[ var ] Ï„ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²
    Prompt : {Ï„ Î± Î² Î²' : typ} {Î¼Î± Î¼áµ¢ : trail} {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
             (id : is-id-trails Î² Î²' Î¼sáµ¢) â†’
             (e : term[ var ] Î² âŸ¨ Î¼sáµ¢ âŸ© Î²' âŸ¨ âˆ™ âŸ© Ï„) â†’
             term[ var ] Ï„ âŸ¨ []{Î¼Î±} âŸ© Î± âŸ¨ Î¼Î± âŸ© Î±

mutual
  âŸ¦_âŸ§Ï„ : (Ï„ : typ) â†’ Set
  âŸ¦ Nat âŸ§Ï„ = â„•
  âŸ¦ Tbool âŸ§Ï„ = ğ”¹
  âŸ¦ Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² âŸ§Ï„ =
    (v : âŸ¦ Ï„â‚‚ âŸ§Ï„) â†’ (k : âŸ¦ Ï„â‚ âŸ§Ï„ â†’ âŸ¦ Î¼[Î²]Î± âŸ§Î¼s â†’ âŸ¦ Î± âŸ§Ï„) â†’ (t : âŸ¦ Î¼Î² âŸ§Î¼) â†’
    âŸ¦ Î² âŸ§Ï„

  âŸ¦_âŸ§Î¼ : (t : trail) â†’ Set
  âŸ¦ âˆ™ âŸ§Î¼ = âŠ¤
  âŸ¦ Ï„ â‡’ Ï„' , Î¼ âŸ§Î¼ = (v : âŸ¦ Ï„ âŸ§Ï„) â†’ (t : âŸ¦ Î¼ âŸ§Î¼) â†’ âŸ¦ Ï„' âŸ§Ï„

  âŸ¦_âŸ§Î¼s : {Î¼Î± Î¼Î² : trail} â†’ (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ Set
  âŸ¦_âŸ§Î¼s {Î¼Î±} Î¼s = âŸ¦ Î¼Î± âŸ§Î¼

cons-trail : {Ï„â‚ Ï„â‚‚ : typ}{Î¼ Î¼Î± Î¼Î² : trail} â†’
             (c : compatible (Ï„â‚ â‡’ Ï„â‚‚ , Î¼) Î¼Î± Î¼Î²) â†’
             (k : âŸ¦ Ï„â‚ â‡’ Ï„â‚‚ , Î¼ âŸ§Î¼) â†’ (t : âŸ¦ Î¼Î± âŸ§Î¼) â†’ âŸ¦ Î¼Î² âŸ§Î¼
cons-trail {Î¼Î± = âˆ™} refl k tt = k
cons-trail {Î¼Î± = Ï„Î± â‡’ Ï„Î±' , Î¼Î±} {Ï„Î² â‡’ Ï„Î²' , Î¼Î²}
           (refl , refl , c) k k' =
  Î» v t' â†’ k v (cons-trail c k' t')

append-trail : {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
               (c : compatible Î¼Î± Î¼Î² Î¼Î³) â†’
               (k : âŸ¦ Î¼Î± âŸ§Î¼) â†’ (t : âŸ¦ Î¼Î² âŸ§Î¼) â†’ âŸ¦ Î¼Î³ âŸ§Î¼
append-trail {âˆ™} refl tt t = t
append-trail {Ï„Î± â‡’ Ï„Î±' , Î¼Î±} c k t = cons-trail c k t

idk : {Ï„â‚ Ï„â‚‚ : typ} {Î¼ : trail} â†’
      is-id-trail Ï„â‚ Ï„â‚‚ Î¼ â†’ âŸ¦ Ï„â‚ âŸ§Ï„ â†’ âŸ¦ Î¼ âŸ§Î¼ â†’ âŸ¦ Ï„â‚‚ âŸ§Ï„
idk {Î¼ = âˆ™} refl v tt = v
idk {Î¼ = Ï„ â‡’ Ï„' , .âˆ™} (refl , refl , refl) v k = k v tt

idt = âˆ™

mutual
  âŸ¦_âŸ§v : {Ï„ : typ} â†’ (v : value[ âŸ¦_âŸ§Ï„ ] Ï„) â†’  âŸ¦ Ï„ âŸ§Ï„
  âŸ¦ Var x âŸ§v = x
  âŸ¦ Num n âŸ§v = n
  âŸ¦ Fun e âŸ§v = Î» v  â†’ âŸ¦ e v âŸ§

  âŸ¦_âŸ§ : {Ï„ Î± Î² : typ} {Î¼Î± Î¼Î² : trail} {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
        (e : term[ âŸ¦_âŸ§Ï„ ] Ï„ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
        (k : âŸ¦ Ï„ âŸ§Ï„ â†’  âŸ¦ Î¼Î± âŸ§Î¼ â†’ âŸ¦ Î± âŸ§Ï„) â†’ (t : âŸ¦ Î¼Î² âŸ§Î¼) â†’ âŸ¦ Î² âŸ§Ï„
  âŸ¦ Val v âŸ§ k t = k âŸ¦ v âŸ§v t
  âŸ¦ App eâ‚ eâ‚‚ âŸ§ k t = âŸ¦ eâ‚ âŸ§ (Î» vâ‚ â†’ âŸ¦ eâ‚‚ âŸ§ (Î» vâ‚‚ â†’ vâ‚ vâ‚‚ k)) t
  âŸ¦ Plus eâ‚ eâ‚‚ âŸ§ k t = âŸ¦ eâ‚ âŸ§ (Î» vâ‚ â†’ âŸ¦ eâ‚‚ âŸ§ (Î» vâ‚‚ â†’ k (vâ‚ + vâ‚‚))) t
  âŸ¦ Control id câ‚ câ‚‚ e âŸ§ k t =
    âŸ¦ e (Î» v k' t' â†’ k v (append-trail câ‚‚ t (cons-trail câ‚ k' t'))) âŸ§
    (idk id) tt
  âŸ¦ Prompt id e âŸ§ k t = k (âŸ¦ e âŸ§ (idk id) tt) t

mutual
  data SubstVal {var : typ â†’ Set} : {Ï„â‚ Ï„â‚‚ : typ} â†’
                (var Ï„â‚ â†’ value[ var ] Ï„â‚‚) â†’
                value[ var ] Ï„â‚ â†’
                value[ var ] Ï„â‚‚ â†’ Set where
   -- (Î»x.x)[v] â†’ v
    sVar= : {Ï„â‚ : typ} {v : value[ var ] Ï„â‚} â†’
            SubstVal (Î» x â†’ Var x) v v
   -- (Î»_.x)[v] â†’ x
    sVarâ‰  : {Ï„â‚ Ï„â‚‚ : typ} {v : value[ var ] Ï„â‚‚} {x : var Ï„â‚} â†’
            SubstVal (Î» _ â†’ Var x) v (Var x)
   -- (Î»_.n)[v] â†’ n
    sNum  : {Ï„â‚ : typ} {v : value[ var ] Ï„â‚} {n : â„•} â†’
            SubstVal (Î» _ â†’ Num n) v (Num n)
   -- (Î»y.Î»x.ey)[v] â†’ Î»x.eâ€²
    sFun  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² : typ} {Î¼Î± Î¼Î² : trail} {Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
            {eâ‚ : var Ï„ â†’ var Ï„â‚‚ â†’ term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
            {v : value[ var ] Ï„} â†’
            {eâ‚â€² : var Ï„â‚‚ â†’ term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²} â†’
            ((x : var Ï„â‚‚) â†’ Subst (Î» y â†’ (eâ‚ y) x) v (eâ‚â€² x)) â†’
            SubstVal (Î» y â†’ Fun (eâ‚ y)) v (Fun eâ‚â€²)

  data Subst {var : typ â†’ Set} : {Ï„ Ï„â‚ Î± Î² : typ}{Î¼Î± Î¼Î² : trail} {Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
             (var Ï„ â†’ term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
             value[ var ] Ï„ â†’
             term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² â†’ Set where

     sVal  : {Ï„ Ï„â‚ Ï„â‚ƒ : typ}{Î¼Î± : trail} â†’
             {vâ‚ : var Ï„ â†’ value[ var ] Ï„â‚} â†’
             {v : value[ var ] Ï„} â†’
             {vâ‚â€² : value[ var ] Ï„â‚} â†’
             SubstVal vâ‚ v vâ‚â€² â†’
             Subst{Î± = Ï„â‚ƒ}{Î¼Î± = Î¼Î±} (Î» z â†’ Val (vâ‚ z)) v (Val vâ‚â€²)

     sApp  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
             {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
             {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
             {Î¼[Î´]Î³ : trails[ Î¼Î´ ] Î¼Î³} â†’
             {Î¼[Î´]Î± : trails[ Î¼Î´ ] Î¼Î±} â†’
             {eâ‚ : var Ï„ â†’ term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)
                            âŸ¨ Î¼[Î´]Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´}
             {eâ‚‚ : var Ï„ â†’ term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³}
             {v : value[ var ] Ï„}
             {eâ‚â€² : term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)
                            âŸ¨ Î¼[Î´]Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´}
             {eâ‚‚â€² : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³} â†’
             Subst eâ‚ v eâ‚â€² â†’ Subst eâ‚‚ v eâ‚‚â€² â†’
             Subst{Î¼s = Î¼[Î´]Î±} (Î» y â†’ App (eâ‚ y) (eâ‚‚ y))
                   v
                   (App eâ‚â€² eâ‚‚â€²)

     sPlu : {Ï„ Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
            {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
            {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
            {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
            {eâ‚ : var Ï„ â†’ term[ var ] Nat âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³}
            {eâ‚‚ : var Ï„ â†’ term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²}
            {v : value[ var ] Ï„}
            {eâ‚â€² : term[ var ] Nat âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ }
            {eâ‚‚â€² : term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²  } â†’
            Subst eâ‚ v eâ‚â€² â†’ Subst eâ‚‚ v eâ‚‚â€² â†’
            Subst{Î¼s = Î¼[Î³]Î±} (Î» y â†’ Plus (eâ‚ y) (eâ‚‚ y)) v (Plus eâ‚â€² eâ‚‚â€²)



     sCon : {Ï„â‚ƒ Ï„ Î± Î² Î³ Î³' tâ‚ tâ‚‚ : typ} {Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² : trail}
            {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
            {Î¼sâ‚ : trails[ Î¼â‚‚ ] Î¼â‚} â†’
            {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
            {id : is-id-trails Î³ Î³' Î¼sáµ¢} â†’
            {câ‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€} â†’
            {câ‚‚ : compatible Î¼Î² Î¼â‚€ Î¼Î±} â†’
            {eâ‚ : var Ï„â‚ƒ â†’
                  var (Ï„ â‡’ tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
                   term[ var ] Î³ âŸ¨ Î¼sáµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²} â†’
            {v : value[ var ] Ï„â‚ƒ} â†’
            {eâ‚â€² : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
                   term[ var ] Î³ âŸ¨ Î¼sáµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²} â†’
            ((k : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±)) â†’
                 Subst (Î» y â†’ (eâ‚ y) k) v ((eâ‚â€² k))) â†’
            Subst{Î¼s = Î¼[Î²]Î±} (Î» y â†’ Control id câ‚ câ‚‚ (eâ‚ y))
                  v
                  (Control id câ‚ câ‚‚ eâ‚â€²)

     sPro : {Ï„â‚ Ï„ Î² Î²' Î± : typ} {Î¼Î± Î¼áµ¢ : trail} {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
            {id : is-id-trails Î² Î²' Î¼sáµ¢} â†’
            {eâ‚ : var Ï„â‚ â†’ term[ var ] Î² âŸ¨ Î¼sáµ¢ âŸ© Î²' âŸ¨ âˆ™ âŸ© Ï„} â†’
            {v : value[ var ] Ï„â‚} â†’
            {eâ‚â€² : term[ var ] Î² âŸ¨ Î¼sáµ¢ âŸ© Î²' âŸ¨ âˆ™ âŸ© Ï„} â†’
            Subst eâ‚ v eâ‚â€² â†’
            Subst {Î± = Î±}{Î¼Î± = Î¼Î±} (Î» y â†’ Prompt id (eâ‚ y)) v
                  (Prompt id eâ‚â€²)


data frame[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : typ â†’ Set)
     : (Ï„ : typ) {Î¼Î± Î¼Î² : trail} â†’ (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ (Î± : typ) â†’ (Î¼Î² : trail) â†’ (Î² : typ) â†’
       (Ï„â‚‚ : typ) {Î¼Î±â‚‚ Î¼Î²â‚‚ : trail} â†’ (Î¼sâ‚‚ : trails[ Î¼Î²â‚‚ ] Î¼Î±â‚‚) â†’ (Î±â‚‚ : typ) â†’ (Î¼Î²â‚‚ : trail) â†’ (Î²â‚‚ : typ) â†’
       Set where
       
     --typ â†’ trails[_]_ â†’ typ â†’ trail â†’ typ â†’ typ â†’ trails â†’ typ â†’ trail â†’ typ â†’ Set where
  Appâ‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
         {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
         {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
         {Î¼[Î´]Î³ : trails[ Î¼Î´ ] Î¼Î³} â†’
         {Î¼[Î´]Î± : trails[ Î¼Î´ ] Î¼Î±} â†’
         (eâ‚‚ : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
         frame[ var , (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼[Î´]Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´ ]
                Ï„â‚ âŸ¨ Î¼[Î´]Î± âŸ© Î± âŸ¨ Î¼Î´ âŸ© Î´

  Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
         {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
         {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
         {Î¼[Î´]Î³ : trails[ Î¼Î´ ] Î¼Î³} â†’
         {Î¼[Î´]Î± : trails[ Î¼Î´ ] Î¼Î±} â†’
         (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)) â†’
         frame[ var , Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ]
                Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚ : {Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
          {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
          {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
          {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
          (eâ‚‚ : term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          frame[ var , Nat âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼[Î³]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚‚ : {Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
          {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
          {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
          (vâ‚ : value[ var ] Nat) â†’
          frame[ var , Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼[Î³]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³
            

  Pro  : {Ï„ Î± Î² Î²' : typ} {Î¼Î± Î¼áµ¢ : trail} {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
         (id : is-id-trails Î² Î²' Î¼sáµ¢) â†’
         frame[ var , Î² âŸ¨ Î¼sáµ¢ âŸ© Î²' âŸ¨ âˆ™ âŸ© Ï„ ] Ï„ âŸ¨ []{Î¼Î±} âŸ© Î± âŸ¨ Î¼Î± âŸ© Î±

frame-plug : {var : typ â†’ Set}
             {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
             {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼t : trails[ Î¼Î´ ] Î¼Î³} â†’
             frame[ var , Ï„â‚‚ âŸ¨ Î¼s âŸ© Ï„â‚„ âŸ¨ Î¼Î² âŸ© Ï„â‚… ] Ï„â‚ âŸ¨ Î¼t âŸ© Ï„â‚ƒ âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
             term[ var ] Ï„â‚‚ âŸ¨ Î¼s âŸ© Ï„â‚„ âŸ¨ Î¼Î² âŸ© Ï„â‚… â†’
             term[ var ] Ï„â‚ âŸ¨ Î¼t âŸ© Ï„â‚ƒ âŸ¨ Î¼Î´ âŸ© Ï„â‚†
frame-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
frame-plug {Î¼Î² = Î¼Î²}(Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚
frame-plug (Plusâ‚ eâ‚‚) eâ‚ = Plus eâ‚ eâ‚‚
frame-plug (Plusâ‚‚ vâ‚) eâ‚‚ = Plus (Val vâ‚) eâ‚‚

frame-plug {Ï„â‚ = Ï„â‚}{Ï„â‚‚ = Ï„â‚‚}{Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚„ = Ï„â‚„}{Î¼Î± = Î¼Î±}{Î¼Î³ = Î¼Î³} (Pro x) eâ‚ =
           Prompt x eâ‚

  --frame
data pframe[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : typ â†’ Set)
     : (Ï„ : typ) {Î¼Î± Î¼Î² : trail} â†’ (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ (Î± : typ) â†’ (Î¼Î² : trail) â†’ (Î² : typ) â†’
       (Ï„â‚‚ : typ) {Î¼Î±â‚‚ Î¼Î²â‚‚ : trail} â†’ (Î¼sâ‚‚ : trails[ Î¼Î²â‚‚ ] Î¼Î±â‚‚) â†’ (Î±â‚‚ : typ) â†’ (Î¼Î²â‚‚ : trail) â†’ (Î²â‚‚ : typ) â†’ Set where
       
  Appâ‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î´ : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
         {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
         {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
         {Î¼[Î´]Î³ : trails[ Î¼Î´ ] Î¼Î³} â†’
         {Î¼[Î´]Î± : trails[ Î¼Î´ ] Î¼Î±} â†’
         (eâ‚‚ : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
         pframe[ var , (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) âŸ¨ Î¼[Î´]Î³ âŸ© Î³ âŸ¨ Î¼Î´ âŸ© Î´ ]
                Ï„â‚ âŸ¨ Î¼[Î´]Î± âŸ© Î± âŸ¨ Î¼Î´ âŸ© Î´

  Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³  : trail}
         {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
         {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
         (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²)) â†’
         pframe[ var , Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ]
                Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚ : {Î± Î² Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
          {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
          {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
          {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
          (eâ‚‚ : term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
          pframe[ var , Nat âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼[Î³]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

  Plusâ‚‚ : {Î± Î³ : typ} {Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
          {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
          {Î¼[Î³]Î± : trails[ Î¼Î³ ] Î¼Î±} â†’
          (vâ‚ : value[ var ] Nat) â†’
          pframe[ var , Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³ ] Nat âŸ¨ Î¼[Î³]Î± âŸ© Î± âŸ¨ Î¼Î³ âŸ© Î³

pframe-plug : {var : typ â†’ Set}
              {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
              {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼t : trails[ Î¼Î´ ] Î¼Î³} â†’
              pframe[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
              term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
              term[ var ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚†

pframe-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
pframe-plug (Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚
pframe-plug (Plusâ‚ eâ‚‚) eâ‚ = Plus eâ‚ eâ‚‚
pframe-plug (Plusâ‚‚ vâ‚) eâ‚‚ = Plus (Val vâ‚) eâ‚‚


data same-pframe {var : typ â†’ Set}:
                 {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' : typ}
                 {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' Î¼Î´ Î¼Î´' : trail}
                 {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼s' : trails[ Î¼Î²' ] Î¼Î±'}
                 {Î¼t : trails[ Î¼Î´ ] Î¼Î³}{Î¼t' : trails[ Î¼Î´' ] Î¼Î³'} â†’
       pframe[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
       pframe[ var , Ï„â‚' âŸ¨ Î¼s' âŸ© Ï„â‚‚' âŸ¨ Î¼Î²' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼t' âŸ© Ï„â‚…' âŸ¨ Î¼Î´' âŸ© Ï„â‚†' â†’
       Set where
 -- Appâ‚ : {Ï„ Î² Î³ Ï„â‚‚ Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' : typ}{Î¼â‚ Î¼â‚‚ Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' : trail}
 --        {Î¼s : trails[ Î¼Î² ] Î¼Î³}{Î¼s' : trails[ Î¼Î²' ] Î¼Î³}{Î¼t : trails[ Î¼Î² ] Î¼Î³}{Î¼t' : trails[ Î¼Î²' ] Î¼Î³'}
 --        {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î³'}
 --        {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
 --        (eâ‚‚ : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
 --        same-pframe {Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚ƒ'}{Ï„â‚„}{Ï„â‚„'}{Ï„â‚…}{Ï„â‚…'}{Î¼Î² = Î¼Î²}{Î¼Î²'}{Î¼Î³}{Î¼Î³'}
 --                    {Î¼s = Î¼s}{Î¼s' = Î¼s'}{Î¼t = Î¼t}{Î¼t' = Î¼t'}
 --                    (Appâ‚ {Î¼[Î²]Î± = Î¼t} eâ‚‚) (Appâ‚ {Î¼[Î²]Î± = Î¼[Î²]Î±}  eâ‚‚)

 Appâ‚ : {Ï„ Î² Î³ Ï„â‚‚ Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' : typ}{Î¼â‚ Î¼â‚‚ Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' : trail}
        {Î¼[Î²]Î³ : trails[ Î¼Î² ] Î¼Î³}{Î¼[Î²']Î³ : trails[ Î¼Î²' ] Î¼Î³}{Î¼[Î²']Î³' : trails[ Î¼Î²' ] Î¼Î³'}
        {Î¼[Î²]Î³' : trails[ Î¼Î² ] Î¼Î³'}
        {Î¼[Î³]Î² : trails[ Î¼Î³ ] Î¼Î²} â†’
        (eâ‚‚ : term[ var ] Ï„â‚‚ âŸ¨ Î¼[Î³]Î² âŸ© Î² âŸ¨ Î¼Î³ âŸ© Î³) â†’
        same-pframe {Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚ƒ'}{Ï„â‚„}{Ï„â‚„'}{Ï„â‚…}{Ï„â‚…'}{Î¼Î² = Î¼Î²}{Î¼Î²'}{Î¼Î³}{Î¼Î³'}
                    {Î¼s = Î¼[Î²]Î³}{Î¼s' = Î¼[Î²']Î³}{Î¼t = Î¼[Î²]Î³}{Î¼t' = Î¼[Î²']Î³'}
                    (Appâ‚{Î¼[Î²]Î± = Î¼[Î²]Î³} eâ‚‚) (Appâ‚{Î¼[Î²]Î± = Î¼[Î²]Î³'} eâ‚‚)


 Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Ï„â‚ƒ Ï„â‚ƒ' Î´ : typ}{Î¼Î± Î¼â‚ Î¼â‚‚ Î¼Î² Î¼Î²' Î¼Î´ : trail}
        {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±}{Î¼s : trails[ Î¼Î² ] Î¼Î²} â†’
        (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² )) â†’
        same-pframe {Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚ƒ' = Ï„â‚ƒ'}{Î¼s = Î¼s}{Î¼s' = Î¼s} (Appâ‚‚  vâ‚) (Appâ‚‚ vâ‚)

 Plusâ‚ : {Î± Î² Î³ Ï„â‚ƒ Ï„â‚ƒ' : typ} {Î¼Î± Î¼Î² Î¼Î³ Î¼Î²' : trail}
         {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±}{Î¼s : trails[ Î¼Î² ] Î¼Î²}{Î¼s' : trails[ Î¼Î²' ] Î¼Î²}
         {Î¼t : trails[ Î¼Î² ] Î¼Î±}{Î¼t' : trails[ Î¼Î²' ] Î¼Î±} â†’
         (eâ‚‚ : term[ var ] Nat âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î²) â†’
         same-pframe {Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚ƒ'}{Î¼Î² = Î¼Î²}{Î¼Î²'}{Î¼s = Î¼s}{Î¼s' = Î¼s'}{Î¼t = Î¼t}{Î¼t' = Î¼t'} (Plusâ‚ eâ‚‚) (Plusâ‚ eâ‚‚)

 Plusâ‚‚ : {Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : typ} {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : trail}
         {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼s' : trails[ Î¼Î²' ] Î¼Î±'}
         {Î¼t : trails[ Î¼Î² ] Î¼Î±}{Î¼t' : trails[ Î¼Î²' ] Î¼Î±'} â†’
         (vâ‚ : value[ var ] Nat) â†’
         same-pframe {Ï„â‚‚ = Ï„â‚‚}{Ï„â‚‚'}{Ï„â‚ƒ}{Ï„â‚ƒ'}{Î¼Î± = Î¼Î±}{Î¼Î±'}{Î¼Î²}{Î¼Î²'}
                     {Î¼s = Î¼s}{Î¼s' = Î¼s'}{Î¼t = Î¼t}{Î¼t' = Î¼t'} (Plusâ‚‚ vâ‚) (Plusâ‚‚ vâ‚)



data pcontext[_,_âŸ¨_âŸ©_âŸ¨_âŸ©_]_âŸ¨_âŸ©_âŸ¨_âŸ©_ (var : typ â†’ Set)
     : (Ï„ : typ) {Î¼Î± Î¼Î² : trail} â†’ (Î¼s : trails[ Î¼Î² ] Î¼Î±) â†’ (Î± : typ) â†’ (Î¼Î² : trail) â†’ (Î² : typ) â†’
       (Ï„â‚‚ : typ) {Î¼Î±â‚‚ Î¼Î²â‚‚ : trail} â†’ (Î¼sâ‚‚ : trails[ Î¼Î²â‚‚ ] Î¼Î±â‚‚) â†’ (Î±â‚‚ : typ) â†’ (Î¼Î²â‚‚ : trail) â†’ (Î²â‚‚ : typ) â†’ Set where
       
  Hole : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
         pcontext[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ
  Frame : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† Ï„â‚‡ Ï„â‚ˆ Ï„â‚‰ : typ}{Î¼â‚ Î¼â‚‚ Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
          {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼t : trails[ Î¼Î´ ] Î¼Î³}{Î¼u : trails[ Î¼â‚ ] Î¼â‚‚} â†’
          (f : pframe[ var , Ï„â‚„ âŸ¨ Î¼s âŸ© Ï„â‚… âŸ¨ Î¼Î² âŸ© Ï„â‚† ] Ï„â‚‡ âŸ¨ Î¼u âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚ âŸ© Ï„â‚‰ ) â†’
          (c : pcontext[ var , Ï„â‚ âŸ¨ Î¼t âŸ© Ï„â‚‚ âŸ¨ Î¼Î´ âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼s âŸ© Ï„â‚… âŸ¨ Î¼Î² âŸ© Ï„â‚† ) â†’
          pcontext[ var , Ï„â‚ âŸ¨ Î¼t âŸ© Ï„â‚‚ âŸ¨ Î¼Î´ âŸ© Ï„â‚ƒ ] Ï„â‚‡ âŸ¨ Î¼u âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚ âŸ© Ï„â‚‰

pcontext-plug : {var : typ â†’ Set}
                {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
                {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼t : trails[ Î¼Î´ ] Î¼Î³} â†’
                pcontext[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
                term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
                term[ var ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚†
pcontext-plug Hole eâ‚ = eâ‚
pcontext-plug (Frame f p) eâ‚ = pframe-plug f (pcontext-plug p eâ‚)

data same-pcontext {var : typ â†’ Set} :
                   {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' : typ}
                   {Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼Î³ Î¼Î³' Î¼Î´ Î¼Î´' : trail}
                   {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼s' : trails[ Î¼Î²' ] Î¼Î±'}
                   {Î¼t : trails[ Î¼Î´ ] Î¼Î³}{Î¼t' : trails[ Î¼Î´' ] Î¼Î³'} â†’
                   pcontext[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚† â†’
                   pcontext[ var , Ï„â‚' âŸ¨ Î¼s' âŸ© Ï„â‚‚' âŸ¨ Î¼Î²' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼t' âŸ© Ï„â‚…' âŸ¨ Î¼Î´' âŸ© Ï„â‚†' â†’
                   Set where
     Hole  : {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' : typ}{Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' : trail}
             {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼s' : trails[ Î¼Î²' ] Î¼Î±'} â†’
             same-pcontext {Ï„â‚ = Ï„â‚}{Ï„â‚' = Ï„â‚'}{Ï„â‚‚ = Ï„â‚‚}{Ï„â‚‚' = Ï„â‚‚'}{Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚ƒ' = Ï„â‚ƒ'}
                           {Î¼Î± = Î¼Î±}{Î¼Î±' = Î¼Î±'}{Î¼Î² = Î¼Î²}{Î¼Î²' = Î¼Î²'}{Î¼s = Î¼s}{Î¼s' = Î¼s'}
                           Hole Hole
     Frame : {Ï„â‚ Ï„â‚' Ï„â‚‚ Ï„â‚‚' Ï„â‚ƒ Ï„â‚ƒ' Ï„â‚„ Ï„â‚„' Ï„â‚… Ï„â‚…' Ï„â‚† Ï„â‚†' Ï„â‚‡ Ï„â‚‡' Ï„â‚ˆ' Ï„â‚ˆ Ï„â‚‰ Ï„â‚‰' : typ}
             {Î¼â‚ Î¼â‚' Î¼â‚‚ Î¼â‚‚' Î¼â‚ƒ Î¼â‚ƒ' Î¼â‚„ Î¼â‚„' Î¼â‚… Î¼â‚…' Î¼â‚† Î¼â‚†' : trail}
             {Î¼s : trails[ Î¼â‚„ ] Î¼â‚ƒ}{Î¼t : trails[ Î¼â‚† ] Î¼â‚…}
             {Î¼s' : trails[ Î¼â‚„' ] Î¼â‚ƒ'}{Î¼t' : trails[ Î¼â‚†' ] Î¼â‚…'}
             {Î¼u : trails[ Î¼â‚‚ ] Î¼â‚}{Î¼u' : trails[ Î¼â‚‚' ] Î¼â‚'} â†’
             {fâ‚ : pframe[ var , Ï„â‚„ âŸ¨ Î¼s âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚† ] Ï„â‚‡ âŸ¨ Î¼t âŸ© Ï„â‚ˆ âŸ¨ Î¼â‚† âŸ© Ï„â‚‰ } â†’
             {fâ‚‚ : pframe[ var , Ï„â‚„' âŸ¨ Î¼s' âŸ© Ï„â‚…' âŸ¨ Î¼â‚„' âŸ© Ï„â‚†' ] Ï„â‚‡' âŸ¨ Î¼t' âŸ© Ï„â‚ˆ' âŸ¨ Î¼â‚†' âŸ© Ï„â‚‰' } â†’
             same-pframe fâ‚ fâ‚‚ â†’
             {câ‚ : pcontext[ var , Ï„â‚ âŸ¨ Î¼u âŸ© Ï„â‚‚ âŸ¨ Î¼â‚‚ âŸ© Ï„â‚ƒ ] Ï„â‚„ âŸ¨ Î¼s âŸ© Ï„â‚… âŸ¨ Î¼â‚„ âŸ© Ï„â‚† } â†’
             {câ‚‚ : pcontext[ var , Ï„â‚' âŸ¨ Î¼u' âŸ© Ï„â‚‚' âŸ¨ Î¼â‚‚' âŸ© Ï„â‚ƒ' ] Ï„â‚„' âŸ¨ Î¼s' âŸ© Ï„â‚…' âŸ¨ Î¼â‚„' âŸ© Ï„â‚†' } â†’
             same-pcontext câ‚ câ‚‚ â†’
             same-pcontext (Frame fâ‚ câ‚) (Frame fâ‚‚ câ‚‚)


data Reduce {var : typ â†’ Set} :
            {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
            term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
            term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’ Set where
  RBeta   : {Ï„ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
            {eâ‚ : var Ï„ â†’ term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ} â†’
            {vâ‚‚ : value[ var ] Ï„} â†’
            {eâ‚â€² : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ} â†’
            Subst eâ‚ vâ‚‚ eâ‚â€² â†’
            Reduce (App (Val (Fun eâ‚)) (Val vâ‚‚)) eâ‚â€²

  RPlus   : {Ï„â‚‚ : typ}{Î¼Î± : trail} â†’
            {nâ‚ : â„•} â†’
            {nâ‚‚ : â„•} â†’
            Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±} (Plus (Val (Num nâ‚)) (Val (Num nâ‚‚))) (Val (Num (nâ‚ + nâ‚‚)))

  RFrame  : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Î´ : trail}
            {Î¼s : trails[ Î¼Î² ] Î¼Î±}{Î¼t : trails[ Î¼Î´ ] Î¼Î³} â†’
            {eâ‚ : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ} â†’
            {eâ‚‚ : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ} â†’
            (f : frame[ var , Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ]
                      Ï„â‚„ âŸ¨ Î¼t âŸ© Ï„â‚… âŸ¨ Î¼Î´ âŸ© Ï„â‚†) â†’
            Reduce eâ‚ eâ‚‚ â†’
            Reduce (frame-plug f eâ‚) (frame-plug f eâ‚‚)

  RPrompt : {Ï„â‚‚ Î² : typ}{Î¼Î± : trail} â†’
            {vâ‚ : value[ var ] Î²} â†’
            Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±}(Prompt refl (Val vâ‚)) (Val vâ‚)

    
  -- RControl : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î³' tâ‚ tâ‚‚ Î±' : typ} {Î¼â‚€ Î¼â‚ Î¼â‚ƒ Î¼áµ¢ Î¼Î± Î¼Î² Î¼Î±' : trail}
  --            {Î¼[Î±]Î± : trails[ Î¼Î±' ] Î¼Î±'} â†’ 
  --            {Î¼[âˆ™]Î¼â‚ƒ : trails[ âˆ™ ] Î¼â‚ƒ} â†’
  --            {Î¼[Î¼â‚€]Î¼â‚ƒ : trails[ Î¼â‚€ ] Î¼â‚ƒ} â†’  
  --            {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
  --            {Î¼[âˆ™]Î¼áµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
  --            (pâ‚ : pcontext[ var , Ï„ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ]
  --                           Ï„â‚ âŸ¨ Î¼[âˆ™]Î¼â‚ƒ âŸ© Ï„â‚‚ âŸ¨ âˆ™ âŸ© Î² ) â†’
  --            (pâ‚‚ : pcontext[ var , Ï„ âŸ¨ []{Î¼Î±'} âŸ© Î±' âŸ¨ Î¼Î±' âŸ© Î±' ]
  --                           Ï„â‚ âŸ¨ Î¼[Î¼â‚€]Î¼â‚ƒ âŸ© Ï„â‚‚ âŸ¨ Î¼â‚€ âŸ© Î± ) â†’
  --            {idâ‚€ : is-id-trails Ï„â‚ Ï„â‚‚ Î¼[âˆ™]Î¼â‚ƒ} â†’
  --            (id : is-id-trails Î³ Î³' Î¼[âˆ™]Î¼áµ¢) â†’
  --            (câ‚ : compatible (Ï„â‚ â‡’ Ï„â‚‚ , Î¼â‚ƒ) Î¼â‚€ Î¼â‚€) â†’
  --            (câ‚‚ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
  --            same-pcontext pâ‚ pâ‚‚ â†’
  --            (e : var (Ï„ â‡’ Ï„â‚ âŸ¨ Î¼[Î¼â‚€]Î¼â‚ƒ âŸ© Ï„â‚‚ âŸ¨ Î¼â‚€ âŸ© Î±) â†’
  --                  term[ var ] Î³ âŸ¨ Î¼[âˆ™]Î¼áµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²) â†’
  --             Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±} (Prompt idâ‚€
  --                   (pcontext-plug pâ‚ (Control id câ‚ câ‚‚ e)))
  --                   (Prompt{Î¼sáµ¢ = Î¼[âˆ™]Î¼áµ¢} id (App (Val (Fun e))
  --                   (Val (Fun (Î» x â†’ pcontext-plug pâ‚‚ (Val (Var x)))))))
             

  RControl : {Ï„ Î± Î±' Î² Î²' Î³ Î³' tâ‚ tâ‚‚ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… : typ}
             {Î¼â‚€ Î¼â‚ Î¼áµ¢ Î¼Î± Î¼Î±' Î¼Î² Î¼Î²' Î¼â‚‚ Î¼â‚ƒ Î¼â‚„ Î¼â‚… : trail} â†’
             {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
             {Î¼[âˆ™]Î¼â‚ƒ : trails[ âˆ™ ] Î¼â‚ƒ} â†’
             {Î¼[Î¼â‚‚]Î¼â‚ : trails[ Î¼â‚‚ ] Î¼â‚} â†’
             {Î¼[âˆ™]Î¼áµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
              (pâ‚ : pcontext[ var , Ï„ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ]
                             Ï„â‚ âŸ¨ Î¼[âˆ™]Î¼â‚ƒ âŸ© Ï„â‚‚ âŸ¨ âˆ™ âŸ© Î² ) â†’
              (pâ‚‚ : pcontext[ var , Ï„ âŸ¨ []{Î¼Î±'} âŸ© Î±' âŸ¨ Î¼Î±' âŸ© Î±' ]
                             tâ‚ âŸ¨ Î¼[Î¼â‚‚]Î¼â‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î± ) â†’
              {idâ‚€ : is-id-trails Ï„â‚ Ï„â‚‚ Î¼[âˆ™]Î¼â‚ƒ} â†’
              (id : is-id-trails Î³ Î³' Î¼[âˆ™]Î¼áµ¢) â†’
              (câ‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€) â†’
              (câ‚‚ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
              same-pcontext pâ‚ pâ‚‚ â†’
              (e : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼[Î¼â‚‚]Î¼â‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’ term[ var ] Î³ âŸ¨ Î¼[âˆ™]Î¼áµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²) â†’
              Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±} (Prompt idâ‚€
                     (pcontext-plug pâ‚ (Control id câ‚ câ‚‚ e)))
                     (Prompt{Î¼sáµ¢ = Î¼[âˆ™]Î¼áµ¢} id (App (Val (Fun e))
                     (Val (Fun (Î» x â†’ pcontext-plug pâ‚‚ (Val (Var x)))))))
                     
-- RControl : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ Î³' tâ‚ tâ‚‚ Î±' : typ} {Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² Î¼Î±' : trail}
--              {Î¼[Î±]Î± : trails[ Î¼Î±' ] Î¼Î±'} â†’ 
--              {Î¼sáµ¢ : trails[ âˆ™ ] Î¼áµ¢} â†’
--              {Î¼sâ‚ : trails[ Î¼â‚‚ ] Î¼â‚} â†’  
--              {Î¼[Î²]Î± : trails[ Î¼Î² ] Î¼Î±} â†’
--              (pâ‚ : pcontext[ var , Ï„ âŸ¨ Î¼[Î²]Î± âŸ© Î± âŸ¨ Î¼Î² âŸ© Î² ]
--                             Ï„â‚ âŸ¨ Î¼sáµ¢ âŸ© Ï„â‚‚ âŸ¨ âˆ™ âŸ© Î² ) â†’
--              (pâ‚‚ : pcontext[ var , Ï„ âŸ¨ [] âŸ© Î±' âŸ¨ Î¼Î±' âŸ© Î±' ]
--                             tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î± ) â†’
--              {idâ‚€ : is-id-trails Ï„â‚ Ï„â‚‚ Î¼sáµ¢} â†’
--              (id : is-id-trails Î³ Î³' Î¼sáµ¢) â†’
--              (câ‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€) â†’
--              (câ‚‚ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
--              same-pcontext pâ‚ pâ‚‚ â†’
--              (e : var (Ï„ â‡’ tâ‚ âŸ¨ Î¼sâ‚ âŸ© tâ‚‚ âŸ¨ Î¼â‚‚ âŸ© Î±) â†’
--                    term[ var ] Î³ âŸ¨ Î¼sáµ¢ âŸ© Î³' âŸ¨ âˆ™ âŸ© Î²) â†’
--               Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±} (Prompt idâ‚€
--                     (pcontext-plug pâ‚ (Control id câ‚ câ‚‚ e)))
--                     (Prompt{Î¼sáµ¢ = Î¼sáµ¢} id (App (Val (Fun e))
--                     (Val (Fun (Î» x â†’ pcontext-plug pâ‚‚ (Val (Var x)))))))


data Reduce* {var : typ â†’ Set} :
             {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
             term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’
             term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ â†’ Set where

  R*Id    : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
            (e : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ ) â†’
            Reduce* e e
  R*Trans : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail}{Î¼s : trails[ Î¼Î² ] Î¼Î±} â†’
            (eâ‚ : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ) â†’
            (eâ‚‚ : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ) â†’
            (eâ‚ƒ : term[ var ] Ï„â‚ âŸ¨ Î¼s âŸ© Ï„â‚‚ âŸ¨ Î¼Î² âŸ© Ï„â‚ƒ) â†’
            Reduce eâ‚ eâ‚‚ â†’
            Reduce* eâ‚‚ eâ‚ƒ â†’
            Reduce* eâ‚ eâ‚ƒ

