\documentclass[japanese,draft]{jssst_ppl} %% 日本語 (default)
% \documentclass[english]{jssst_ppl} %% English
% \documentclass[japanese,draft]{jssst_ppl} %% You can use the draft option
\usepackage{proof}
\newtheorem{definition}{定義}
\newtheorem{proposition}[definition]{命題}
\newtheorem{lemma}[definition]{補題}
\newtheorem{theorem}[definition]{定理}
\input{macro}
\title{control/prompt のための CPS 変換とその正当性の証明}
\author{本田　華歩, 浅井　健一}
\inst{%
 お茶の水女子大学\\
\texttt{pon@pllab.is.ocha.ac.jp, asai@is.ocha.ac.jp}
}
\begin{document}
\maketitle
\begin{abstract}
継続をプログラム中で扱うには control/prompt や shift/reset など継続を切り取って扱う限定継続演算子が使われる。その意味論は継続渡し形式(continuation-passing style; CPS)に変換することで与えられるが、これまで CPS 変換の正当性は shift/reset 入りの体系において議論されてきた。また、型システムにおいては、control/prompt が含まれる体系は、shift/reset が含まれる体系と違い、継続が連なっている trail という新しい概念を取り入れなければならない。そのため CPS 変換においても扱う型が増えると同時に、型制約も必要になり、正当性の証明は複雑になる。本研究では、定理証明支援系言語である Agda において control/prompt が含まれた体系でのCPSインタプリタとCPS変換を定式化し、正当性を証明する。ただし、control のケースにおいて論理関係が必要となった部分については手で証明を行なった。
\end{abstract}

\section{はじめに}
継続とは、ある時点における残りの計算のことを意味する。例えば、1 + (2 * 3)という計算で(2 * 3)を実行しているときの継続は、「2 * 3の結果を受け取って、そこに1を加える」ということになる。プログラムの中で継続を扱う方法として、プログラム全体を継続渡し形式(continuation-passing style; CPS)に変換するというものがある。

本稿は、単純型付きλ計算に限定継続演算子であるcontrol/prompt\cite{POPL88}を加えた体系でのCPS変換の証明の定式化を目指している。control/promptは四種ある限定継続演算子のうちの一つで、controlが「その時点での継続を切り取ってくる命令」、promptが「切り取られる継続の範囲を限定する命令」である。同じく限定継続演算子の一種であるshift/reset\cite{DF1990} においてはCPS変換の証明が定式化されており、本稿ではそれをcontrol/promptに拡張する。

control/promptはshift/resetの定式化のときに加えて、継続が連なったtrailという概念が加わっているため更に持っている型が増えている。例えば、shift/resetの際は一つの型で表現されていた継続は、control/promptではtrailが入ったことにより$\Arrow{\tau_1}{\Arrow{\mu_{\alpha}}{\alpha}}$という三つの型で表現される。trailの構造に対しても場合分けが必要になり、手で証明するのは困難であるためAgda上で証明を行う。ただし、論理関係の定義が必要な部分の証明は手で行った。

以下、2節でcontrol/prompt入り単純型付き$\lambda$計算の定式化を、3節でCPS変換を定式化した上で、4節でCPS変換の正当性を証明する。また、5節で関連研究を、6節でまとめと今後の課題を述べる。

\section{DS項とCPS変換}
この節では CPS 変換の入力となる DS 項と CPS 変換を定義する。
\subsection{DS項の定義}
本稿で扱う言語は、単純型付き$\lambda$計算に control/prompt を加えた体系である。本稿では、この言語を直接形式 (direct style) で書かれた項という意味で CPS 項と対比して DS 項と呼ぶ。その構文を図\ref{DSsyntax}に示す。
\begin{figure}[h]
\[
\begin{array}{rrcl}
       値 & v & := & x \ | \ \Lam{x}{e}\\
       項 & e & := & v\  |\ \App{e_1}{e_2}\ |
       \ \Control{c}{e}\ |\ \Prompt{e} \\
[3mm]
       ピュアフレーム & F^p & := & \App{[]}{e}\ |\ \App{v}{[]}\\
       ピュアな評価文脈 & E^p & := & []\ |\ F^p[E^p]\\
       フレーム & F & := & \App{[]}{e}\ |\ \App{v}{[]}\ |\ \Prompt{[]}\\
       評価文脈 & E & := & []\ |\ F[E]
\end{array}
\]
\caption{DS項の構文}
\label{DSsyntax}
\end{figure}
値は変数・$\lambda$抽象のふたつからなり、項は値か関数適用かcontrol/promptである。図\ref{DSsyntax}の後半には評価文脈が定義されている。ふたつのフレームの規則は left-to-right の実行順を表現している。また、ピュアなフレーム、評価文脈は、hole が prompt に囲まれていない評価文脈を表していて、controlの簡約規則を定義するときに使われる。

$\Prompt{e}$ は prompt と呼ばれ、$e$ の継続を限定する命令、$\Control{c}{e}$ は control と呼ばれ、現在の限定継続を切り取り、$c$ に束縛して、$e$ を実行する命令である。ここで、切り取られる限定継続の周りには prompt が入らない点が shift とは異なる点である。例えば、以下のプログラム\cite{FSCD2021}を考える。
\[
\begin{array}{c}
  \Prompt{(\Control{k_1}{\textsf{is0}\ (k_1\ 5)})\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})}
\end{array}
\]
\textsf{is0}は渡された整数が0かどうかを判定する関数、\textsf{b2s}はbool型をstring型に\textsf{"true"}・\textsf{"false"}のように変換する関数である。上のプログラムは以下のように実行される。
\[
\begin{array}{l}
  \Prompt{(\Control{k_1}{\textsf{is0}\ (k_1\ 5)})\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})}\\
  =\ \Prompt{\textsf{is0}\ (k_1\ 5)\ [\Lam{x}{x}\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})/k_1]}\\
  =\ \Prompt{\textsf{is0}\ (5\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)}))}\\
  =\ \Prompt{\textsf{b2s}\ (k_2\ 8)[\Lam{x}{\textsf{is0}\ (5 + x)}/k_2]}\\
  =\ \Prompt{\textsf{b2s}\ (\textsf{is0}\ (5+8))}\\
  =\ \Prompt{\textsf{b2s}\ (\textsf{is0}\ 13)}\\
  =\ \Prompt{\textsf{"false"}}\\
  =\ \textsf{"false"}
\end{array}
\]

最初のcontrolオペレーターでは、promptによって$[.]+(\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})$([.]はhole)という継続が切り取られている。そしてそれを$\Lam{x}{x}\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})$と$\lambda$の形式で$k_1$に渡している。ここで、k1 に渡される継続の本体部分は（shift とは異なり）
  $\Lam{x}{\langle x}\ +\ (\Control{k_2}{\textsf{b2s}\ (k_2\ 8)})\rangle$ のように prompt は\textbf{つかない}ことに注意しよう。そしてその上で$\textsf{is0}\ (k_1\ 5)$の実行に移る。$k_1$に$\lambda$抽象を代入して関数適用を行うと、再度controlの項が出てくる。このcontrolでは、$\textsf{is0}\ (5 + [.])$という継続が切り取られ、$\Lam{x}{\textsf{is0}\ (5 + x)}$という形で$k_2$に渡される。ここでも $k2$ に渡される継続の本体部分には prompt はつかない。ここで、$k1$ に入っている継続の本体部分に prompt が存在していたら $5+[.]$ が prompt で囲まれるため、ここで切り取られる継続は $5+[.]$ のみとなるところだったが、prompt では囲まれていないため \textsf{is0} も一緒に切り取られている。その上で$\textsf{b2s}\ (k_2\ 8)$を実行するので$k_2$に渡った$\lambda$抽象に8を関数適用して$\Prompt{\textsf{b2s}\ (\textsf{is0}\ (5+8))}$となる。ここでも、$\textsf{is0} (5 + [.])$ の周りには prompt がないので、\textsf{b2s} も一緒に切
り取られることになる。このように$k_1$を呼び出した時の継続と$k_2$を呼び出した時の継続が連なっていることが分かる。promptの中身、$\textsf{b2s}\ (\textsf{is0}\ 13)$は実行すると\textsf{"false"}となり、これは値になっているためpromptの外側に出すことができる。つまり、\textsf{"false"}がこのプログラムの結果となる。

例から分かるように、control/promptオペレーターを使うことによって、「切り取られた継続を呼び出す時の継続」（上の例では \textsf{is0} と \textsf{b2s}）が連なっていく。これがtrailの概念である。

\subsection{簡約関係}
図\ref{reduction}に簡約関係を示す。
\begin{figure}[h]
\[
  \begin{array}{cc}
    \infer[\RBeta]{\App{\LamP{x}{e}}{v}\ \rightarrow_{\beta}\ e'}
                  {e[\Change{x}{v}]\ =\ e'}
  & \infer[\RFrame]{F[e]\ \rightarrow_{\beta}\ F[e']}
                   {e\ \rightarrow_{\beta}\ e'}\\
\\[3mm]
    \infer[\RControl]{\Prompt{E^p[\Control{c}{e}]}\ \rightarrow_{\beta}\ \Prompt{\App{\LamP{c}{e}}{\LamP{x}{E^p[x]}}}}{}
  & \infer[\RPrompt]{\Prompt{v}\ \rightarrow_{\beta}\ v}{} 
          

  \end{array}
\]
\caption{簡約規則}
\label{reduction}
\end{figure}

$\RBeta$ は普通の$\beta$簡約で、そこに出てくる $e[v/x]$ は $e$ の中の $x$ に $v$ を代入した式を示す。また $\RFrame$ は簡約を任意の call by value かつ left to right なフレーム（図\ref{DSsyntax}参照）の下で行うことを許す規則である。$\RControl$ は、control が実行されると、直近の prompt までの継続を$\LamP{x}{E^p[x]}$という形で切り出してきて、それを $c$ に代入して $e$ を実行することを示す。ここで、$E$ はピュアな評価文脈、つまり評価文脈のうち hole を
prompt で囲わないような評価文脈を示す。これで、直近の prompt までの継続を切り出している。切り出した継続には $\LamP{x}{\langle E^p[x] \rangle}$ のように prompt が入ってはいないことに注意をしよう。ここが shift と control で異なる部分である。最後に $\RPrompt$ は、prompt の中身が値になったら、それが prompt 全体の値となることを示す。

\subsection{CPS変換}
図\ref{CPSTrans}にCPS変換を示す。この定義は、アンダーラインとオーバーラインを無視すれば、control/prompt に対する CPS インタプリタになっている。このインタプリタは、継続と trail を渡していく形で書かれている。trail が使われるのは control と prompt 命令のみなので、$\lambda$計算部分については単に trail を引き回しているだけであり、$\eta$-簡約すれば通常の CPS インタプリタと同一になる。
\begin{figure}[h]
\[
\begin{array}{rcl}
  \CPS{x}{\rho}{k}{t} & = & \SApp{\SApp{k}{\rho(x)}}{t}\\
  
  \CPS{\Lam{x}{e}}{\rho}{k}{t} & = & 
      {\SApp{\SApp{k}
                  {\DLamP{v}{\DLam{k'}{\DLam{t'}
                    {\CPS{e}{\rho[\Change{x}{v}]}
           {\SLamP{a}{\SLam{t''}
                 {\DApp{\DApp{k'}{a}}{t''}}}}
                  {t'}}}}}}
        {t}}\\
                  
  \CPS{\App{e_1}{e_2}}{\rho}{k}{t} & = & \CPS{e_1}{\rho}
      {\SLamP{v_1}{\SLam{t_1}{\CPS{e_2}{\rho}
            {\SLamP{v_2}{\SLam{t_2}
                {\DAppP{\DAppP{\DAppP{v_1}{v_2}}
                    {\DLamP{v}{\DLam{t''}
                        {\SApp{\SApp{k}{v}}{t''}}}}}{t_2}}}}{t_1}}}}{t}\\
  
  \CPS{e_1 + e_2}{\rho}{k}{t} & = & \CPSTh{e_1}\, \rho \,
      (\SLamS v_1 .\, \SLamS t_1 .\, \CPSTh{e_2} \, \rho \,
         (\SLamS v_2 .\, \SLamS t_2 .\,\\
  & &  \DLet{v}{v_1+v_2}{\SApp{k}{\SApp{v}{t_2}}})\, t_1)\, t\\
  
  \CPS{\Control{c}{e}}{\rho}{k}{t} & = & \DLet{x'}
      {\DLam{v}{\DLam{k'}{\DLam{t'}
        {\DLet{t''}{\DAppend{t}{\DCons{k'}{t'}}}{\SApp{\SApp{k}{v}}{t''}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}}\\
      
  \CPS{\Prompt{e}}{\rho}{k}{t} & = &
      \DLet{v}{\CPS{e}{\rho}{\Idk}{\Idt}}{\SApp{\SApp{k}{v}}{t}}\\

\end{array}
\]
\caption{CPS変換の定義}
\label{CPSTrans}
\end{figure}

$\Prompt{e}$ を実行する際には、$e$ を初期継続 $\Idk$ と初期 trail である $\Idt$ のもとで実行する。このようにすることで、$e$ の中で継続を捕捉したとしても$\Prompt{e}$ の外側の継続 $k$ や trail $t$ が捕捉されることはなくなる。つまり、$e$ の継続をここまでで限定していることになる。$e$ の実行結果が出たら、それが外側の継続 $k$ に渡されていくことになる。

$\Control{c}{e}$ を実行する際にも、その body 部分である $e$ は $\Idk$ と $\Idt$ の元で実行される。しかし、prompt の場合とは違って $e$ では変数 $c$ を通じて限定継続にアクセスできるようになっている。その定義 $x'$ は、捕捉した限定継続 $k$を実行するというものだが、その際、捕捉した trail である $t$ を「$x'$ を実行したときの継続 $k'$ と trail $t'$」（つまり呼び出し文脈）と結合している。このようにすることで、$k$ の実行中に再び control が使われた際、呼び出し文脈も含めて補足することができるようになっている。

ここで、trail を結合するのに使われる @ と :: の定義は図\ref{ConsAppend}に示されている。@ と :: をリストの \textsf{append} と \textsf{cons} と解釈すると Yonezawa, Kameyama \cite{KY2008} らが採用しているように、trail は呼び出し文脈のリストになるが、本稿では trail は関数で表現されており、図\ref{ConsAppend}に示す形で合成される。
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Cons{k}{\Idt} & = & k\\
  \Cons{k}{k'} & = & \Lam{v}{\Lam{t'}{k\,v\,(\Cons{k'}{t'})}}\\
  \Append{\Idk}{t} & = & t\\
  \Append{k}{t} & = & \Cons{k}{t}\\
\end{array}
\]
\caption{@ と :: の定義}
\label{ConsAppend}
\end{figure}

以上が CPS インタプリタの説明だが、この CPS インタプリタに対して、オーバーラインとアンダーラインを引くと、1-pass の CPS 変換と解釈することができるようになる。ここで、アンダーラインのついた式は dynamic な式と呼び、これはその構文を出力することを意味する。一方、オーバーラインのついた式は static な式と呼び、これは CPS 変換時に実行してしまうことを示す。CPS 変換時に administrative redex と呼ばれる簡約基を簡約してしまうことで、簡潔な CPS 変換結果が得られるようになる。

\subsection{型システム}
これまで、型のことには触れずに項の定義、簡約関係の定義、そして CPS 変換を示してきたが、本稿ではこれらを全て型付きで定式化している。図\ref{TypeDef}に型の定義を示す。
\\
\begin{figure}[h]
\[ 
\begin{array}{rrcl}
       型 & \tau & := & b\  |\ \TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}\\
       trail & \mu & := & \bullet\ |\ \Trail{\tau_1}{\tau_1'}{\mu_1}\\
\end{array}
\]
\caption{型定義}
\label{TypeDef}
\end{figure}

\begin{figure}[h]
\[
\begin{array}{c}
\infer[\TVar]
      {\JudgeTrail{\Gamma}{x}{\tau}{\TrailsType{\alpha}{\alpha}}
                                   {\TrailType{\alpha}}}
      {\Gamma(x)=\tau}
\\[3mm]
\infer[\TFun]
      {\JudgeTrail{\Gamma}{\DLam{x}{e}}
                  {\ArrowTrailP{\tau_2}{\tau_1}
                               {\TrailsType{\alpha}{\beta}}
                               {\TrailType{\beta}}}
                  {\TrailType{\gamma}}
                  {\TrailType{\gamma}}}
      {\JudgeTrail{\Gamma,x:\tau_2}{e}{\tau_1}
                  {\TrailsType{\alpha}{\beta}}
                  {\TrailType{\beta}}}
\\[3mm]
\infer[\TApp]
      {\JudgeTrail{\Gamma}{\DApp{e_1}{e_2}}
                  {\tau_1}{\TrailsType{\alpha}{\delta}}{\TrailType{\delta}}}
      {\JudgeTrail{\Gamma}{e_1}
                  {\ArrowTrailP{\tau_2}{\tau_1}{\TrailsType{\alpha}{\beta}}
                                               {\TrailType{\beta}}}
                  {\TrailsType{\gamma}{\delta}}
                  {\TrailType{\delta}}
      &\JudgeTrail{\Gamma}{e_2}{\tau_2}{\TrailsType{\beta}{\gamma}}{\TrailType{\gamma}}}
\\[3mm]
\infer[\TControl]
      {\JudgeTrail{\Gamma}{\DControl{k}{e}}{\tau}
                  {\TrailsType{\alpha}{\beta}}
                  {\TrailType{\beta}}}
      {\begin{array}{c}
       \IsIdTrail{\gamma}{\gamma'}{\MuId}\\
       \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0}\quad
       \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha}\\
       \JudgeTrail{\Gamma,k:\ArrowTrail{\tau}{t_1}
                              {\TType{\mu_1}{t_2}}
                              {\TType{\mu_2}{\alpha}}}
                  {e}{\gamma}
                  {\TsType{\MuId}{\gamma'}{\Bullet}}
                  {\TType{\Bullet}{\beta}}
       \end{array}}
\\[3mm]
\infer[\TPrompt]
      {\JudgeTrail{\Gamma}{\DReset{e}}{\tau}{\TrailsType{\alpha}{\alpha}}
                                            {\TrailType{\alpha}}}
      {\IsIdTrail{\beta}{\beta'}{\MuId}
      &\JudgeTrail{\Gamma}{e}{\beta}
                  {\TsType{\MuId}{\beta'}{\Bullet}}
                  {\TType{\Bullet}{\tau}}}
\end{array}
\]
\caption{型システム}
\label{TypeSystem}
\end{figure}

型は nat や bool などのベースタイプを示す $b$ か関数型のどちらかである。\\
関数型 $\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}$ は、基本的には $\tau_2$ 型の値を受け取ったら $\tau_1$ 型の値を返す関数だが、継続と trail を扱うために answer type として $\alpha$ と $\beta$、そして trail の型として $\mu_{\alpha}$と $\mu_{\beta}$ を保持している。全体として（CPS インタプリタにおいて）$\tau_2$型の値と、$\tau_1 \rightarrow \mu_{\alpha} \rightarrow \alpha$ 型の継続、$\mu_{\beta}$ 型の trail を受け取ったら、最終結果が $\beta$ 型となるような関数」を示す。

初期 trail である $\Idt$ の型は $\Bullet$、呼び出し文脈を表す継続がひとつ以上、連なった trail の型は、その継続を @ や :: を使って合成した継続の型になる。

図\ref{TypeSystem}に型システムを示す。control/prompt に対する型システムは、CPSインタプリタから自然に導くことができる\cite{FSCD2021}。ここで、型判定$\Gamma \vdash e : \tau(\mu_{\alpha})\alpha(\mu_{\beta})\beta$は「型環境 $\Gamma$ の元で式 $e$ は $\tau$ 型を持ち、$\tau \rightarrow \mu_{\alpha} \rightarrow \alpha$ 型の継続と $\mu_{\beta}$ 型の trail の元で実行すると、最終的に $\beta$ 型の値になる」と読む。
ここで $\alpha$ を initial answer type、$\beta$ を final answer type、また$\mu_{\beta}$ を initial trail type、$\mu_{\alpha}$ を final trail type と呼ぶ。（順番が逆になっていることに注意。）

CPS インタプリタ $\CPS{e}{\rho}{k}{t}$ を考えたとき、$e$ の型が $\tau$、$k$ の型が$\tau \rightarrow \mu_{\alpha} \rightarrow \alpha$、$t$ の型が $\mu_{\beta}$ で $\CPS{e}{\rho}{k}{t}$ 全体の型が$\beta$ となっており、各構文に対してそれぞれの型を調べていくと図\ref{typeSystem}の型システムを得ることができる。

ここで、\textsf{id-cont-type} は $\Idk$ が満たさなくてはいけない型制約、\textsf{compatible} は @ と :: が満たさなくてはいけない型制約を表し、図\ref{IsidCompatible}のように定義される。それぞれ $\Idk$ と @, :: の定義式（図\ref{ConsAppend}）の各行で型が矛盾しないようにするための制約となっている。

\begin{figure}[h]
\[
\begin{array}{lcl}
  \IsIdTrail{\tau}{\tau'}{\Bullet} & = & \tau \equiv \tau' \\
  \IsIdTrail{\tau}{\tau'}{\Trail{\tau_1}{\tau_1'}{\mu}} & = &
   \tau \equiv \tau_1\ \wedge\ \tau' \equiv \tau_1'\ \wedge\ \mu \equiv \Bullet \\

  \Compatible{\Bullet}{\mu_2}{\mu_3}
  & = & \mu_2 \equiv \mu_3\\
\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}{\Bullet}{\mu_3}
  & = & \Trail{\tau_1}{\tau_1'}{\mu_1} \equiv \mu_3\\
\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}
           {\Trail{\tau_2}{\tau_2'}{\mu_2}}{\Bullet}
  & = & \bot \\
\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}
           {\Trail{\tau_2}{\tau_2'}{\mu_2}}
           {{\tau_3}{\tau_3'}{\mu_3}}
  & = & \tau_1 \equiv \tau_3\ \wedge\ \tau_1' \equiv \tau_3'\ \wedge\\ 
  &   & \Compatible{\Trail{\tau_2}{\tau_2'}{\mu_2}}{\mu_3}{\mu_1}
\end{array}
\]
\caption{\textsf{id-cont-type}・\textsf{compatible}の定義}
\label{IsidCompatible}
\end{figure}

図\ref{TypeSystem}の型システムは、基本的には \cite{FSCD2021} で示した型システムと同一だが、後にCPS 変換の証明を行う際に必要な性質を得るため、$\mu_{\alpha}[_{\mu_{\beta}}]$ という型を final trail type の部分で使用している。この型は、基本的には$\mu_{\alpha}$ のことだが、その型が $\mu_{\beta}$ に 0 個以上の呼び出し文脈をくっつけた形で得られることを表現しており、図\ref{TrailsDef}のように定義される。

\begin{figure}[h]
\[
\begin{array}{rrcl}
  trails & \mu_s & := & \bullet\ |\ \mu k :: \langle c \rangle \ \mu_{\beta} \lbrack {_{\mu_{\alpha}}} \rbrack\\
\end{array}
\]
\caption{trails の定義}
\label{TrailsDef}
\end{figure}

$\mu_{\alpha}[_{\mu_{\beta}}]$ の形の型は、必ず$\tau \TrailsType{\alpha}{\beta}\TrailType{\beta}$のように現れ、特に [.] の中の型と initial trail type は必ず等しくなる。これで、final trail type は常に initial trail type に呼び出し文脈を 0個以上くっつけたもの（final trail type は initial trail type を拡張したもの）になっていることを型システムレベルで表現している。この性質は、\cite{FSCD2021} の型システムから導出できると予想されるが、その方法が明らかではなかったため、その性質を埋め込んだ型システムを採用している。

%% 型システムに出てきた$\Is$と$\Co$は、それぞれ$\Is$は初期継続$\Idk$と、$\Co$はtrailと継続を繋げる\textsf{cons}・\textsf{append}と関係がある。$\Idk$・\textsf{cons}・\textsf{append}において両辺で型が等しい事を保証するために作られた制約である。それぞれ定義と対応しているので、下に示す。
%% \begin{figure}[h]
%% \[
%% \begin{array}{lcl}
%%   \Idk\  v\  \Idt & = & v\\
%%   \Idk\  v\  k & = & k\ v\ \Idt\\

%%   \IsIdTrail{\tau}{\tau'}{\Bullet} & = & \tau \equiv \tau' \\
%% \IsIdTrail{\tau}{\tau'}{\Trail{\tau_1}{\tau_1'}{\mu}} & = &
%%   \tau \equiv \tau_1\ \wedge\ \tau' \equiv \tau_1'\ \wedge\ \mu \equiv \Bullet \\
%% \end{array}
%% \]
%% \caption{$\Idk$の定義と$\Is$}
%% \end{figure}

%% \begin{figure}[h]
%% \[
%% \begin{array}{lcl}
%%   \Cons{k}{\Idt} & = & k\\
%%   \Cons{k}{k'} & = & \Lam{v}{\Lam{t'}{k\,v\,(\Cons{k'}{t'})}}\\
%%   \Append{\Idk}{t} & = & t\\
%%   \Append{k}{t} & = & \Cons{k}{t}\\

%%   \Compatible{\Bullet}{\mu_2}{\mu_3}
%%   & = & \mu_2 \equiv \mu_3\\
%% \Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}{\Bullet}{\mu_3}
%%   & = & \Trail{\tau_1}{\tau_1'}{\mu_1} \equiv \mu_3\\
%% \Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}
%%            {\Trail{\tau_2}{\tau_2'}{\mu_2}}{\Bullet}
%%   & = & \bot \\
%% \Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}
%%            {\Trail{\tau_2}{\tau_2'}{\mu_2}}
%%            {{\tau_3}{\tau_3'}{\mu_3}}
%%   & = & \tau_1 \equiv \tau_3\ \wedge\ \tau_1' \equiv \tau_3'\ \wedge\\ 
%%   &   & \Compatible{\Trail{\tau_2}{\tau_2'}{\mu_2}}{\mu_3}{\mu_1}
%% \end{array}
%% \]
%% \caption{\textsf{cons}・\textsf{append}の定義と$\Co$}
%% \end{figure}




\section{CPS変換の正当性}
CPS変換の正当性を、一部を除いてAgdaで実装した。この節ではCPS変換の正当性を証明する。そのために証明に必要な補題から見ていく。
\subsection{補題}
\begin{lemma}[CPS変換と代入の可換性]
  任意の項$e_1$、値$v$、継続$k$、trail $t$について$\LamP{x}{e_1\,x}[v]\mapsto e_2$が成り立つとき、$\LamP{x}{\CPSTh{e_1\,x} \SAppS k \SAppS t}[\CPSTh{v}] \mapsto \CPSTh{e_2} \SAppS k \SAppS t$が成り立つ。
\end{lemma}
これは$e_1$の中にある$x$を$v$に置き換えると$e_2$になる時、$e_1$のCPS変化後の項にある$x$を$v$のCPS変換後の値で置き換えると$e_2$のCPS変換結果になる、つまり代入とCPS変換の可換性を示している。

\begin{lemma}[継続に関する代入演算]
  任意の項$e$、値$v$、trail $t$、$schematic$な継続$k$について\\
  $\LamP{x}{\CPSTh{e} \SAppS (k_1\, x) \SAppS t}[v] \mapsto \CPSTh{e} \SAppS (k_1\,v) \SAppS t$が成り立つ。
\end{lemma}
継続$k$の変数の構造が変わらない場合、$k$の中の$x$を$v$で置き換えられることを示している。

\begin{lemma}[継続の簡約に関する補題]
  任意の項$e_1$、値$v$、trail $t$、$schematic$な継続$k_1$について\\
  $(k_1 \SAppS \CPSTh{v} \SAppS t) \to (k_2 \SAppS \CPSTh{v} \SAppS t)$が成り立つとき、
  $\CPSTh{e}\SAppS k_1 \SAppS t_2 \to \CPSTh{e}\SAppS k_2 \SAppS t_2$が成り立つ。
\end{lemma}
継続の部分を同じ意味を持つものに置き換え証明を進めたい時に使う。

\subsection{正当性の証明}
CPS変換前の項を簡約した後にCPS変換した項と、CPS変換後の項が$\beta$同値であること、
つまり以下の定理を示す。
% 定理4
\begin{theorem}[正当性の証明]
  任意の項$e$,$\, e'$について$e \to e'$が成り立つならば任意のtrail $t$とschematicな継続$\kappa$に対して$\CPSTh{e}\SAppS k \SAppS t =_{\beta} \CPSTh{e'} \SAppS k \SAppS t$が成り立つ。
\end{theorem}

ここで$=_{\beta}$は$\beta$同値である。
$schematic$というのは、「引数の変数の構造を変更しない」性質のことである。
本稿で扱う継続$k$は値とtrailの二つを受け取るため、
次の二式がこの性質を表す。\\
\[
\begin{array}{lcl}
  (k \SAppS x \SAppS t)[\Change{x}{v}] & = & k \SAppS v \SAppS t\\
  (k \SAppS v \SAppS x)[\Change{x}{t}] & = & k \SAppS v \SAppS t\\
\end{array}
\]

証明は、$e \to e'$の簡約規\textsf{RBeta}・\textsf{RFrame}・\textsf{RControl}・\textsf{RPrompt}で場合分けして実装した。\textsf{RControl}以外はCPS変換の定義と簡約規則を適用し、補題を使って変形することによって示すことができた。この部分はAgdaに載せることができた。\textsf{RControl}では、前述した補題の他にcontrolのための補題を立てる必要があった。また、trailに差分の情報を入れ、論理関係を使う必要もあった。これらについて次節以降で見ていく。


\subsection{controlのための補題}
定理4のcontrolのケースでは、任意のtrail tとschematicな継続$k$に対して\\
$\CPSTh{\Prompt{E_p[\Control{c}{e_1}]}}\SAppS k \SAppS t =_{\beta} \CPSTh{\Prompt{\App{\LamP{c}{e_1}}{\LamP{x}{E_p[x]}}}} \SAppS k \SAppS t$ が成り立つ事を示すということになる。そこでコンテキストで囲まれた左辺をCPS変換の定義によって展開できる形に変換するために次の補題を立てた。

\begin{lemma}[context-lemma]
  任意の項$e$、\textsf{trail} $t$、$schematic$な継続$k$について\\
  $\CPSTh{\Prompt{E_p[e]}}\,k\,t =_{\beta} \CPSTh{\App{\LamP{x}{E_p[x]}}{e}}\,k\,t$
\end{lemma}

そして、$\CPSTh{\Prompt{E_p[\Control{c}{e_1}]}}\SAppS k \SAppS t =_{\beta} \CPSTh{\Prompt{\App{\LamP{c}{e_1}}{\LamP{x}{E_p[x]}}}} \SAppS k \SAppS t$を示すためにこの両辺をCPS変換の定義によって展開していく。\\
\begin{figure}[h]
\[
\begin{array}{cl}
 & \CPSTh{\Prompt{\App{\LamP{c}{e_1}}{\LamP{x}{E_p[x]}}}}\,k\,t\\
 = & let\ v = \CPSTh{\App{\LamP{c}{e_1}}{\LamP{x}{E_p[x]}}}(idk)(\bullet)\ in\ 
  k\SAppS v \SAppS t\\
  = & let\ v = \CPSTh{\LamP{c}{e_1}}\ \SLamP{v_1}{
    \SLam{t_1}{\CPSTh{\LamP{x}{E_p[x]}}\ \SLamP{v_2}{
        \SLam{t_2}{\DApp{\DApp{\DApp{v_1}{v_2}}
                    {\DLamP{v_2'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v_2'}}{t''}}}}}{t_2}}}}t_1} \ \bullet\ \\
  & in\ k\SAppS v \SAppS t\\
  = & let\ v = \SLamP{v_1}{
    \SLam{t_1}{\CPSTh{\LamP{x}{E_p[x]}}\ \SLamP{v_2}{
        \SLam{t_2}{\DApp{\DApp{\DApp{v_1}{v_2}}
                    {\DLamP{v_2'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v_2'}}{t''}}}}}{t_2}}}}t_1} \\
  & \SAppS
  \DLamP{ve}{\DLamP{k'e}{\DLamP{t'e}{\CPSTh{e}[\Change{c}{ve}]\
        \SLamP{a}{\SLamP{t''e}{k'e \DAppS a \DAppS t''e}}\ t'e}}} \SAppS \bullet\ in\
  k\SAppS v \SAppS t\\

  = & let\ v = \CPSTh{\LamP{x}{E_p[x]}}\ (\SLamS v_2.\ 
  \SLamS t_2.\ \\
   & \DApp{\DApp{\DApp{\DLamP{ve}{\DLamP{k'e}{\DLamP{t'e}{\CPSTh{e}[\Change{c}{ve}]\
        \SLamP{a}{\SLamP{t''e}{k'e \DAppS a \DAppS t''e}}\ t'e}}}}{v_2}}
                    {\DLamP{v_2'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v_2'}}{t''}}}}}{t_2})\bullet\\
  & in\ k\SAppS v \SAppS t\\

  = & let\ v = (\SLamS v_2.\ 
  \SLamS t_2.\ 
  \DApp{\DApp{\DApp{\DLamP{ve}{\DLamP{k'e}{\DLamP{t'e}{\CPSTh{e}[\Change{c}{ve}]\
        \SLamP{a}{\SLamP{t''e}{k'e \DAppS a \DAppS t''e}}\ t'e}}}}{v_2}}
                    {\DLamP{v_2'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v_2'}}{t''}}}}}{t_2})\\
  & \SAppS \DLamP{vE}{\DLam{k'E}{\DLam{t'E}{\CPSTh{E_p[x]}[\Change{x}{vE}]\
  \SLamP{aE}{\SLam{t''E}{k'E \DAppS aE \DAppS t''E}}\ t'E}}} \SAppS \bullet \ in\
  k\SAppS v \SAppS t\\

  = & let\ v =  \DLamP{ve}{\DLamP{k'e}{\DLamP{t'e}{\CPSTh{e}[\Change{c}{ve}]\
              \SLamP{a}{\SLamP{t''e}{k'e \DAppS a \DAppS t''e}}\ t'e}}}\DAppS\\
      & \DLamP{vE}{\DLam{k'E}{\DLam{t'E}{\CPSTh{E_p[x]}[\Change{x}{vE}]\
              \SLamP{aE}{\SLam{t''E}{k'E \DAppS aE \DAppS t''E}}\ t'E}}} \DAppS
                    \DLamP{v_2'}{\DLam{t''}
                      {\SApp{\SApp{idk}{v_2'}}{t''}}}\DAppS{\bullet}\\
                    & in\ k\SAppS v \SAppS t\\

  \to & let\ v = \CPSTh{e}[\Change{c}{\DLamP{vE}{\DLam{k'E}{\DLam{t'E}{\CPSTh{E_p[x]}[\Change{x}{vE}] \SLamP{aE}{\SLam{t''E}{k'E \DAppS aE \DAppS t''E}}\ t'E}}}}]\\
        & \SLamP{a}{\SLamP{t''e}{\DLamP{v_2'}{\DLam{t''}
              {\SApp{\SApp{idk}{v_2'}}{t''}}} \DAppS a \DAppS t''e}}\ \bullet
  \ in\
  k\SAppS v \SAppS t\\

  \to & let\ v = \CPSTh{e}[\Change{c}{\DLamP{vE}{\DLam{k'E}{\DLam{t'E}{\CPSTh{E_p[x]}[\Change{x}{vE}] \SLamP{aE}{\SLam{t''E}{k'E \DAppS aE \DAppS t''E}}\ t'E}}}}]\\
        & \SLamP{a}{\SLamP{t''e}{
              \SApp{\SApp{idk}{a}}{t''e}}}\ \bullet
  \ in\
  k\SAppS v \SAppS t\\

  \leftarrow & let\ v =\ let\ x'=
  \DLam{v'}{\DLam{k'}{\DLam{t'}{\CPSTh{E_p[x]}[\Change{x}{v'}]\
        \SLamP{a}{\SLam{t''}{k' \DAppS a \DAppS t''}}\ t'}}}\ \\
  & in\ \CPSTh{e}[\Change{c}{x'}]\
  idk\ \bullet \ in\ k\SAppS v \SAppS t\\
\end{array}
\]
\caption{簡約規則右辺の展開}
\label{ControlReRight}
\end{figure}
\\
\\
\begin{figure}[h!]
\[
\begin{array}{cl}
  & \CPSTh{\Prompt{E_p[\Control{c}{e_1}]}}\,k\,t\ \\
  = & let\ v=\CPSTh{E_p[\Control{c}{e_1}]}\ idk\ \bullet\ in\
  k\SAppS v \SAppS t\\

  \to & let\ v=\CPSTh{\App{\LamP{x}{E_p[x]}}{(\Control{c}{e_1})}}\ idk\ \bullet\ in\
  k\SAppS v \SAppS t\ (補題5より)\\

  = & let\ v=\CPSTh{\LamP{x}{E_p[x]}}\ (\SLamS v_1.\SLamS t_1.\CPSTh{\Control{c}{e_1}}\
  (\SLamS v_2.\SLamS t_2.\\ & \DAppP{\DAppP{\DAppP{v_1}{v_2}}
                    {\DLamP{v'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v'}}{t''}}}}}{t_2})\ t_1\ ) \bullet\ in\ k\SAppS v \SAppS t\\

  = & let\ v=(\SLamS v_1.\SLamS t_1.\CPSTh{\Control{c}{e_1}}\
  (\SLamS v_2.\SLamS t_2.\DAppP{\DAppP{\DAppP{v_1}{v_2}}
                    {\DLamP{v'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v'}}{t''}}}}}{t_2})\ t_1\ )\\
 & \SAppS \DLamP{v_3}{\DLam{k_2'}{\DLam{t_2'}{\CPSTh{E_p[x]}[\Change{x}{v_3}]\
        \SLamP{a}{\SLam{t_2''}{k_2' \DAppS a \DAppS t_2''}}\ t_2'}}} \SAppS \bullet \ in\
  k\SAppS v \SAppS t\\

  = & let\ v=(\SLamS v_1.\SLamS t_1.let\ x'= (\DLamS vF.\DLamS k'F.\DLam{t'F}{let\ t''F=\Append{t_1}{\Cons{k'F}{t'F}}}\\
  & in\ (\SLamS v_2.\SLamS t_2.\DAppP{\DAppP{\DAppP{v_1}{v_2}}
                    {\DLamP{v'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v'}}{t''}}}}}{t_2})\SAppS vF \SAppS t''F)\ in\
            \CPSTh{e}[\Change{c}{x'}]\ idk\ \bullet)\\
  & \SAppS \DLamP{v_3}{\DLam{k_2'}{\DLam{t_2'}{\CPSTh{E_p[x]}[\Change{x}{v_3}]\
        \SLamP{a}{\SLam{t_2''}{k_2' \DAppS a \DAppS t_2''}}\ t_2'}}} \SAppS \bullet \ in\
            k\SAppS v \SAppS t\\
[3mm]
  & (中略)\\
[3mm]
  %% = & let\ v=let\ x'= (\DLamS vF.\DLamS k'F.\DLam{t'F}
  %%               {let\ t''F=\Append{\bullet}{\Cons{k'F}{t'F}}}\\
  %% & in\ (\SLamS v_2.\SLamS t_2.\DAppP{\DAppP{\DAppP
  %%     {\DLamP{v_3}{\DLam{k_2'}{\DLam{t_2'}{\CPSTh{E_p[x]}[\Change{x}{v_3}]\
  %%       \SLamP{a}{\SLam{t_2''}{k_2' \DAppS a \DAppS t_2''}}\ t_2'}}}}{v_2}}
  %%                   {\DLamP{v'}{\DLam{t''}
  %%                       {\SApp{\SApp{idk}{v'}}{t''}}}}}{t_2})\\
  %%               & \SAppS vF \SAppS t''F)\ in\ \CPSTh{e}[\Change{c}{x'}]\ idk\ \bullet \ in\
  %%               k\SAppS v \SAppS t\\

  %% = & let\ v=let\ x'= (\DLamS vF.\DLamS k'F.\DLam{t'F}
  %%               {let\ t''F=\Append{\bullet}{\Cons{k'F}{t'F}}}\\
  %% & in\ (\DAppP{\DAppP{\DAppP
  %%     {\DLamP{v_3}{\DLam{k_2'}{\DLam{t_2'}{\CPSTh{E_p[x]}[\Change{x}{v_3}]\
  %%       \SLamP{a}{\SLam{t_2''}{k_2' \DAppS a \DAppS t_2''}}\ t_2'}}}}{vF}}
  %%                   {\DLamP{v'}{\DLam{t''}
  %%                       {\SApp{\SApp{idk}{v'}}{t''}}}}}{t''F}))\ \\
  %%               & in\ \CPSTh{e}[\Change{c}{x'}]\ idk\ \bullet \ in\
  %%               k\SAppS v \SAppS t\\

 \to & let\ v=let\ x'= (\DLamS vF.\DLamS k'F.\DLam{t'F}
                {let\ t''F=\Append{\bullet}{\Cons{k'F}{t'F}}}\\
  & in\ (
     \CPSTh{E_p[x]}[\Change{x}{vF}]\
        \SLamP{a}{\SLam{t_2''}{\DLamP{v'}{\DLam{t''}
                        {\SApp{\SApp{idk}{v'}}{t''}}} \DAppS a \DAppS t_2''}}\ t''F
        )\ in\ \CPSTh{e}[\Change{c}{x'}]\ idk\ \bullet \ \\
        & in\
        k\SAppS v \SAppS t\\


  \to & let\ v=let\ x'= \DLamS v'.\DLamS k'.\DLamS t'.

     \CPSTh{E_p[x]}[\Change{x}{v'}]\
        idk\ \ConsP{k'}{t'}\\
                    & in\ \CPSTh{e}[\Change{c}{x'}]\ idk\ \bullet \ in\
                k\SAppS v \SAppS t\\

\end{array}
\]
\caption{簡約規則左辺の展開}
\label{ControlReLeft}
\end{figure}
図\ref{ControlReRight},\ref{ControlReLeft}に$\beta$同値を示したい両辺の展開を示した。それぞれの最終行に注目したい。両辺を見比べて形が異なっている部分を切り出すと次のようになる。\\
\[
\begin{array}{l}
  \DLam{v'}{\DLam{k'}{\DLam{t'}{\CPSTh{E_p[x]}[\Change{x}{v'}]\
        \SLamP{a}{\SLam{t''}{k' \DAppS a \DAppS t''}}\ t'}}}\\
  \DLamS v'.\DLamS k'.\DLamS t'.

     \CPSTh{E_p[x]}[\Change{x}{v'}]\
     \Idk\ \ConsP{k'}{t'}\\
     
\end{array}
\]
\\
ここで、上の式の継続部分について、$\SLam{a}{\SLam{t''}{k' \DAppS a \DAppS t''}}=\SLam{a}{\SLam{t''}{\Idk \DAppS a \DAppS \ConsP{k'}{t''}}}$と変換できる。なぜなら、$\SLam{a}{\SLam{t''}{\Idk \DAppS a \DAppS \ConsP{k'}{t''}}}$を$\Idk$の定義に従って展開すると
$\SLam{a}{\SLam{t''}{\ConsP{k'}{t''}} \DAppS a \DAppS \Idt}$であり、$t''=\Bullet$の場合には$::$の定義より、$\SLam{a}{\SLam{t''}{k' \DAppS a \DAppS \Idt}}$で、$t''\neq \Bullet$の場合には$\SLam{a}{\SLam{t''}{k' \DAppS a \DAppS t''}}$になるからである。\\
\\
さらに$\Idk = \SLam{a}{\SLam{t''}{\Idk \DAppS a \DAppS t''}}$と表すことが出来ることから上の二式をかなり近い形に変換することができた。
\[
\begin{array}{l}
  \DLam{v'}{\DLam{k'}{\DLam{t'}{\CPSTh{E_p[x]}[\Change{x}{v'}]\
        \SLamP{a}{\SLam{t''}{\Idk \DAppS a \DAppS \ConsP{k'}{t''}}}\ t'}}}\\
  \DLamS v'.\DLamS k'.\DLamS t'.

     \CPSTh{E_p[x]}[\Change{x}{v'}]\
     \SLam{a}{\SLam{t''}{\Idk \DAppS a \DAppS t''}}\ \ConsP{k'}{t'}\\
     
\end{array}
\]
そこで次の重要な補題を立てた。

\begin{lemma}[$k$の移動]
  任意の項$e$、$k$、trail $t$に対して\\
  $\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{t_0}}}}\ \ConsP{k'}{t'}}}}
  =_{\beta} \\
  \Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{\ConsP{k'}{t_0}}}}}\ t'}}}$が成り立つ。
\label{KMove}
\end{lemma}
この補題では、trailに連なっている$k$の位置が継続に渡すtrailに移動しても$\beta$同値が成り立つ事を意味しており、亀山さんの論文\cite{KY2008}にも記載されている。これを補題として、定理4から呼び出すためにはtrailに関していくつかの補題が必要であった。左辺では$k$と$t$を\textsf{cons}で繋げているのに対して、右辺では$k$と$t_0$を継続の中で繋げているため、型を保証する\textsf{compatible}が両辺で異なっている。補題\ref{KMove}を呼び出すためにはこの両方の\textsf{compatible}が必要だったのである。そこでtrailの型を変更して補題を立てた。次節で見ていく。

\subsection{trailの差分情報}
trailの型に差分情報を渡して次のようにAgdaで定義した。


\begin{verbatim}
data trails[_]_ (μα : trail) : trail → Set where
 [] : trails[ μα ] μα
 _::<_>_ : {τ1 τ2 : typ} {μ μβ μγ : trail} →
              (μk : trail) → (c : compatible μβ μk μγ) →
              (μs : trails[ μα ] μβ) →
              trails[ μα ] μγ
\end{verbatim}

trailsはtrailの差分情報を表している。$\mu_{\alpha}$をベースとして、空のtrailを受け取る場合の差分は$\mu_{\alpha}$と$\mu_{\alpha}$の差になる。$\mu_{\alpha}$に1つ以上のtrailを連ねてできた$\mu_s$に空ではない$\mu_k$を連ねる場合は、$\mu_{\beta}$と$\mu_k$を繋げたら型が$\mu_{\gamma}$になる事保証する\textsf{compatible}を同時に渡して$\mu_{\alpha}$から$\mu_{\gamma}$の差分を返している。
このtrailsを使い、持っているtrailsの型から\textsf{compatible}関係を導くことが出来る補題を立てた。これで補題6をメイン定理から呼び出す準備が整った。
\begin{lemma}[diff-compatible]
  $\mu_{\beta}$に一つ以上のtrailが連なって$\mu_{\alpha}$になったtrailsと任意のtrail$\mu_0$について$\Compatible{\mu_{\beta}}{\mu_0}{\mu_{\alpha}}$が成り立つ。
\end{lemma}


\subsection{論理関係を使った手証明}
補題\ref{KMove}を示すにあたって、Appのケースでは2つの項の再帰だけではなく、項が実行された後の値$v$においても補題を満たさなければならないと分かった。つまり、これを示すには論理関係の定義が必要である。論理関係は環境を明示的に表現する必要があり、PHOASを扱うAgdaに載せるのは難しい。そこで補題\ref{KMove}の証明に関しては手証明で進めることにする。補題\ref{KMove}を証明できるように定義した論理関係を下に示す。

\[
\begin{array}{l}
  (M, M')\in R_d \ \Longleftrightarrow\ M =_{\beta}M'\\
  (M, M')\in R_{\tau_2 \rightarrow \tau_1 (\mu_{\alpha}) \alpha (\mu_{\beta})\beta}\\
  \Longleftrightarrow\\
  \forall (V, V')\in R_{\tau_2}.\\
  and\ \forall (k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}\\
  and\ \forall (\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}.\\
  and\  \forall (t, t')\in T_{\mu_{\beta}}.\\
  (M\ V \ \Lam{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}, M\ V' \ \Lam{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\beta}\\
  (M\ V \ \Lam{t_0}{K[\Lam{t_1}{t_1}]}\ t, M\ V' \ \Lam{t_0}{K[\Lam{t_1}{t_1}]}\ t')\in R_{\beta}\\
\end{array}
\]
$k$について\\
\[
\begin{array}{lcl}
  (k,k')\in k_{\tau_1(\mu_{\alpha})\alpha} &\Longleftrightarrow&
  \forall (V, V')\in R_{\tau_1}.\\
  & & and\ \forall (t, t')\in T_{\mu_{\alpha}}.\\
  & & (k\ V\ t, k'\ V'\ t')\in R_{\alpha}\\
\end{array}
\]
コンテキストとtrailについて
\[
\begin{array}{l}
  (\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}}) \in K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}\\
  \Longleftrightarrow\\
  \forall (V, V')\in R_{\tau_1}.\\
  and\ \forall (t, t')\in T_{\mu_{\alpha}}.\\
  (\Lam{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \Cons{k}{t}, \Lam{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ t')\in R_{\alpha}\\
  (\Lam{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ t, \Lam{v_0}{K[\Lam{t_1}{t_1}]}\ V'\ t')\in R_{\alpha}\\
[3mm]
  (t, t')\in T_{bullet}\ \Longleftrightarrow\  t=t'=idt\\
  (t, t')\in T_{\tau(\mu_{\alpha})\alpha}\ \Longleftrightarrow\ t=_{\beta}t'\\
\end{array}
\]
\\
ここで、環境が入った次の定理を示した。
\begin{theorem}
  $x_i:\tau_i \vdash e:\tau \TrailsType{\alpha}{\beta} \TrailType{\beta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$を満たす$k,k'$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\beta}}$を満たす任意の$t, t'$とについて、\\
  $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t}, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\beta}$と\\
  $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\beta}$が成り立つ。
\label{HandMain}
\end{theorem}
%% この定理を示すことで\\
%% $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t}, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\beta}$が得られる。\\
定理\ref{HandMain}を使って補題\ref{KMove}の\\
$(\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{t_0}}}}\ \ConsP{k'}{t'}}}},\\
\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{\ConsP{k'}{t_0}}}}}\ t'}}})
\in R_{\tau_2 \rightarrow \TrailType{\alpha} \TrailType{\beta}}$を示していく。\\
次の補題を使う。\\
\begin{lemma}[簡約と論理関係の保存]
  $(M_l', M_r') \in R_{\tau}、M_l \rightarrow_{\beta} M_l'、M_r \rightarrow_{\beta} M_r'$のとき$(M_l, M_r) \in R_{\tau}$が成り立つ。
\label{Reduction2}
\end{lemma}
$(\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[]}}\ \ConsP{k'}{t'}}}},\\
\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[]}}\ t'}}})
\in R_{\tau_2 \rightarrow \TrailType{\alpha} \TrailType{\beta}}$をまず考える。
\\
任意の$(V,V')\in R_{\tau_2}\  (k_2,k_2')\in k_{\tau_1(\mu_{\alpha})\alpha}\  (\LamP{v_0}{\Lam{t_0}{K[]}},\LamP{v_0}{\Lam{t_0}{K[]}})\in K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}\  (t_2,t_2')\in_{\mu_{\beta}}$について、\\
(A)\ $(\LamP{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k'}{t'}}}}\ V\ k_2\ t_2,\\
\qquad \Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t'}}}\ V'\ k_2'\ t_2')\in R_{\beta}$と\\
(B)\ $(\LamP{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k'}{t'}}}}\ V\ k_2\ t_2,\\
\qquad \Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t'}}}\ V'\ k_2'\ t_2')\in R_{\beta}$を示せば良い。\\
補題\ref{Reduction2}より簡約できるので\\
(A)\ $(\rho \CPSTh{e}[\Change{x}{V}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k_2}{t_2},
 \rho \CPSTh{e}[\Change{x}{V'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k_2'}{t_1}}]}}\ t_2')\in R_{\beta}$\\
(B)\ $(\rho \CPSTh{e}[\Change{x}{V}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2,
 \rho \CPSTh{e}[\Change{x}{V'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2')\in R_{\beta}$\\
\\
定理\ref{HandMain}より、\\
(A)'\ $(\rho \CPSTh{e}[\Change{x}{V}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k_2}{t_2}, \rho \CPSTh{e}[\Change{x}{V'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k_2'}{t_1}}]}}\ t_2')\in R_{\beta}$と\\
(B)'\  $(\rho \CPSTh{e}[\Change{x}{V}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2, \rho \CPSTh{e}[\Change{x}{V'}] \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2')\in R_{\beta}$が成り立つ。\\
これで\\
$(\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[]}}\ \ConsP{k'}{t'}}}},\\
\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\Lam{t_0}{K[]}}\ t'}}})
\in R_{\tau_2 \rightarrow \TrailType{\alpha} \TrailType{\beta}}$が示せた。
\\
ここで、次の補題を使う。
\begin{lemma}
  コンテキスト$\Lam{v_0}{\Lam{t_0}{K[f]}}=\Lam{v_0}{\Lam{t_0}{\Idk\ v_0\ (f\ t_0)}}$は\\
  $(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\beta(\mu_{id})\beta'}$を満たす。
\label{IdkContext}
\end{lemma}
これにより補題\ref{KMove}が示せた。\\
$(\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{t_0}}}}\ \ConsP{k'}{t'}}}},\\
\Lam{v'}{\Lam{k'}{\Lam{t'}{\CPSTh{e}[\Change{x}{v'}] \LamP{v_0}{\LamP{t_0}{\SApp{\Idk}{\SApp{v_0}{\ConsP{k'}{t_0}}}}}\ t'}}})
\in R_{\tau_2 \rightarrow \TrailType{\alpha} \TrailType{\beta}}$\\
\\
メイン定理や補題の詳細な証明方法については付録に記載するが、この証明の核心であるcontrolのケースについて下に示していく。
\subsection{controlケースの手証明}
controlのケースを示すために次の補題が必要となった。
\begin{lemma}
  $\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}{\mu_2}{\mu_3}$かつ$(t_1, t_1')\in T_{\tau_1(\mu_1)\tau_1'}、(t_2, t_2')\in T_{\mu_2}、$のとき\\
  $(\Cons{t_1}{t_2}, \Cons{t_1'}{t_2'})\in T_{\mu_3}$
\label{TCompatible}
\end{lemma}
補題\ref{TCompatible}は、論理関係の$T$の定義と持っている\textsf{compatible}関係から新たな$T$の関係を示すものである。\\
次の\textsf{cons-assoc}についてはAgdaに実装済みである。
\begin{lemma}
  任意のtrail\ $t_1,t_2,t_3$について以下が成り立つ。\\
  $\Cons{\ConsP{t_1}{t_2}}{t_3} =_{\beta} \Cons{t_1}{\ConsP{t_2}{t_3}}$
\label{ConsAssoc}
\end{lemma}
ここから定理\ref{HandMain}についてcontrolのケースの概略を書いていく。\\

示すことは以下のようになる。\\
$x_i:\tau_i\ \vdash \Control{k}{e}:\tau \TrailType{\alpha} \TrailType{\beta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ\\
$(k,k')\in k_{\tau(\mu_{\alpha})\alpha}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t_l, t_r) \in T_{\mu_{\beta}}$を満たす任意の$t, t'$と任意の$k$について、\\
  (A)\ $(\rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t_l}), \rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_r)\in R_{\beta}$と\\
(B)\ $(\rho \CPSTh{\Control{c}{e}}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_l, \rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_r)\in R_{\beta}$が成り立つ。\\
\\
(A)について、CPS変換と$\beta_{\Omega}$を使って以下のように変換できる。\\
(A)\ $(\DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\DAppend{\ConsP{k}{t_l}}{\ConsP{k'}{t'}}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}},\\
\qquad   \DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}})
      \in R_{\beta}$\\
\\
ここで、Agdaで示した補題\ref{ConsAssoc}より$\DAppend{\ConsP{k}{t_l}}{\ConsP{k'}{t'}} =_{\beta} \Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})$である。\\
%% $(\DLet{x'}
%%       {\Lam{v}{\Lam{k'}{\Lam{t'}
%%         {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})}}}}}
%%       {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}},\\
%%    \DLet{x'}
%%       {\Lam{v}{\Lam{k'}{\Lam{t'}
%%         {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}}}
%%       {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}})
%%       \in R_{\beta}$\\
      左右の$x'$の中身をそれぞれ$X,Y$とおくと、\\
      $(\CPS{e}{\rho[\Change{c}{X}]}{\Idk}{\Idt},\CPS{e}{\rho[\Change{c}{Y}]}{\Idk}{\Idt})\in R_{\beta}$を示せば良い。\\
\\
$e$に対しての帰納法の仮定より、\\
$x_i:\tau_i\ c:\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha \vdash e : \gamma (\mu_{id}) \gamma' (\Bullet) \beta$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$で\\
$(k,k')\in k_{\gamma (\mu_{id}) \gamma'}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\gamma (\mu_{id}) \gamma'}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\Bullet}$を満たす任意の$t, t'$について、\\
$(\rho \CPSTh{e}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\beta}$が成り立つ。\\
\\
$\Lam{v_0}{\Lam{t_0}{K[f]}}\ =\ \Lam{v_0}{\Lam{t_0}{\Idk\ v_0\ (f\ t_0)}}$\\
上のコンテキストは$K^{kk'}_{\gamma (\mu_{id}) \gamma'}$を満たし(補題\ref{IdkContext})、$(t, t') \in T_{\Bullet}$より$t=t'=\Idt$なので
帰納法の仮定で(A)を導くには、$(X,Y)\in R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$を示す。\\
%% $(\Lam{v}{\Lam{k'}{\Lam{t'}
%%     {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})}}}},\\
%%   \Lam{v}{\Lam{k'}{\Lam{t'}
%%       {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}})\in R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$\\
\\
$R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$の定義から\\
$(V,V')\in R_{\tau}$と$(k_1,k_1')\in k_{t_1 (\mu_1) t_2}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in K^{k_1k_1'}_{t_1 (\mu_1) t_2}$を満たすコンテキスト$K_1$と$(t_{l2},t_{r2})\in T_{\mu_1}$について\\
(C)\ $(X\ V\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ \ConsP{k_1}{t_{l2}},Y\ V'\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ t_{r2})\in R_{\alpha}$\\
(D)\ $(X\ V\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ t_{l2},Y\ V'\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ t_{r2})\in R_{\alpha}$を示せば良い。\\
\\
(C)について\\
X,Yを代入して補題\ref{Reduction2}より簡約できるので\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \Cons{k}{(\DAppend{t_l}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}{\ConsP{k_1}{t_{l2}}}}}),\\
\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ \DAppend{t_r}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}{t_{r2}}})\in R_{\alpha}$を示す。\\
\\
$(\LamP{v_0}{\Lam{t_0}{K[]}},\LamP{v_0}{\Lam{t_0}{K[]}})\in K^{kk'}_{\tau(\mu_{\alpha})\alpha}$を満たしているから\\
$(V,V')\in R_{\tau}$と$(t, t')\in T_{\mu_{\alpha}}$について\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \ConsP{k}{t},
\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ t')\in R_{\alpha}$\\
\\
そこで、\\
(E)\ $(\DAppend{t_l}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}{\ConsP{k_1}{t_{l2}}}},
\DAppend{t_r}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}{t_{r2}}})\in T_{\mu_{\alpha}}$を示す。\\
\\
ここで、$\Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0}\quad \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha}$である事を考慮して、\\
次のように$trail$を考える。\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%trail設定%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
$\mu_0 = \Trail{t_1}{t_2}{\mu_0}\quad \mu_2 = \Trail{\epsilon}{\epsilon'}{\mu'}$\\
$\mu_{\beta} = \Trail{\delta}{\delta'}{\mu}\quad \mu_{\alpha} = \Trail{\delta}{\delta'}{\mu_{\alpha}}$\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%trail設定%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\\
(E)の$::$と$@$を展開する。
%% (E)\ $(\DAppend{t_l}{\Lam{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}},\\
%% \qquad \DAppend{t_r}{\Lam{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}})\in T_{\mu_{\alpha}}$\\
%% 次に$@$を展開する。
また、$\mu_{\alpha} = \Trail{\delta}{\delta'}{\mu_{\alpha}}$なので\\
(E)\ $(\Lam{v_2}{\Lam{t_2'}{t_l\ v_2\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_2'}}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{t_r\ v_2\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_2'}}})\in T_{\delta(\mu_{\alpha})\delta'}$\\
\\
$T_{\delta(\mu_{\alpha})\delta'}$の定義から\\
$(V_{delta},V_{delta}')\in R_{\delta}$を満たす$V,V'$と$(t_3, t_4)\in T_{\mu_{\alpha}}$を満たす$t_3, t_4$について\\
$(t_l\ V_{delta}\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_3},\\
t_r\ V_{delta}'\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_4})
\in R_{\delta'}$を示せば良い。\\
\\
ここで、$(t_l, t_r)\in T_{\mu_{\beta}}$つまり$(t_l, t_r)\in T_{\delta{\mu}\delta'}$なので定義より、\\
$(V_{delta},V_{delta}')\in R_{\delta}$を満たす$V,V'$とと$(t_{\mu}, t_{\mu}')\in T_{\mu}$を満たす$t_{\mu}, t_{\mu'}$について\\
$(t_l\ V_{delta}\ t_{\mu},t_r\ V_{delta}'\ t_{\mu}')\in R_{\delta'}$となるから\\
\\
(F)\ $(\Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_3},\\
\qquad \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_4})
\in T_{\mu}$を示せば良い。\\
\\
ここで、(F)の$::$を展開し\\
(F)\ $(\Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}\ v_2\ \ConsP{t_3}{t_2'}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}\ v_2\ \ConsP{t_4}{t_2'}})\in T_{\mu}$となる。\\
\\
$\mu$について、\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha} &=& \Compatible{\Trail{\delta}{\delta'}{\mu}}{\Trail{t_1}{\mu_0}{t_2}}{\Trail{\delta}{\mu_{\alpha}}{\delta'}}\\
  &=& \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\mu}
\end{array}
\]
\caption{\textsf{comptible}展開1}
\label{Compatible1}
\end{figure}
より$\mu=\Trail{t_1}{t_2}{\mu'}$と置くことができるので(F)は次のようになる。\\
\\
(F)\ $(\Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}\ v_2\ \ConsP{t_3}{t_2'}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}\ v_2\ \ConsP{t_4}{t_2'}})\in T_{t_1(\mu')t_2}$を示す。\\
定義より、\\
$(V_1,V_1')\in R_{t_1}$と$(t_{\mu_2},t_{\mu_2}')\in T_{\mu'}$について\\
(G)\ $(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \Cons{\ConsP{k_1}{t_{l2}}}{\ConsP{t_3}{t_{\mu_2}}},\\
\qquad \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ \Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in R_{t_2}$を示せば良い。\\
\\
ここで、補題\ref{ConsAssoc}より、$\Cons{\ConsP{k_1}{t_{l2}}}{\ConsP{t_3}{t_{\mu_2}}} =_{\beta} \Cons{k_1}{\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}}}$なので\\
(G)\ $(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \Cons{k_1}{\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}}},\\
\qquad \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ \Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in R_{t_2}$を示せば良い。\\
\\
ここで、$K_1$が$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in K^{k_1k_1'}_{t_1 (\mu_1) t_2}$を満たすので、\\
$(V_1,V_1')\in R_{t_1}$と$(t,t')\in T_{\mu_1}$について\\
$(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \ConsP{k_1}{t}, \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ t)
\in R_{\tau_2}$が言える。\\
\\
つまり、(H)\ $(\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}},\Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in T_{\mu_1}$を示せば良い。
\\
ここで、\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0} &=& \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\Trail{t_1}{t_2}{\mu_0}}\\
  &=& \Compatible{\mu_2}{\mu_0}{\mu_1}
\end{array}
\]
\caption{\textsf{comptible}展開2}
\label{Compatible2}
\end{figure}\\
\\
また、図\ref{Compatible1}の続きから\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\mu} &=& \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\Trail{t_1}{t_2}{\mu'}}\\
  &=& \Compatible{\mu_{\alpha}}{\mu'}{\mu_0}
\end{array}
\]
\caption{\textsf{comptible}展開3}
\label{Compatible3}
\end{figure}\\
\\
(H)を示す。\\
$(t_3,t_4)\in T_{\mu_{\alpha}}\ (t_{\mu_2},t_{\mu_2}')\in T_{\mu'}$で図\ref{Compatible3}より$\Compatible{\mu_{\alpha}}{\mu'}{\mu_0}$\\
補題\ref{TCompatible}より$(\Cons{t_3}{t_{\mu_2}},\Cons{t_4}{t_{\mu_2}'})\in T_{\mu_0}$\\
また、$(t_{l2},t_{r2})\in T_{\mu_2}$で図\ref{Compatible2}より$\Compatible{\mu_2}{\mu_0}{\mu_1}$なので\\
補題\ref{TCompatible}より$(\Cons{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}},\Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in T_{\mu_1}$となる。\\
これで(H)が示せた。\\
(B),(D)についても同様に示す。\\


\section{関連研究}
CPS変換の正当性をshift/reset入りの体系で示した論文に\cite{CHAM2020,CHAM2018}が挙げられる。



\section{まとめと今後の課題}
本稿では、control/prompt入り$\lambda$計算の体系において、CPS変換の正当性を証明した。CPSインタプリタとCPS変換をAgdaで定式化し、正当性の証明については一部を除いてAgdaに実装した。今後は手証明で行った部分をAgdaに実装していきたい。



\bibliographystyle{jplain}
\bibliography{paper}

\newpage
\section*{付録}

\subsection*{A.補題}

%% \begin{lemma}
%%   $(M_l, M_r) \in R_{\tau}、M_l \rightarrow_{\beta} M_l'、M_r \rightarrow_{\beta} M_r'$のとき$(M_l', M_r') \in R_{\tau}$が成り立つ。
%% \label{Reduction1}
%% \end{lemma}
%% 簡約をしても論理関係は変わらないという補題である。\\
%%  \lbrack 証明 \rbrack\\
%%  $T=b$のとき$M_l' =_{\beta} M_r'$を示す。仮定より、$M_l' = _{\beta} M_l$。$(M_l,M_r)\in R_b$\ 。仮定より、$M_r = _{\beta} M_r'$なので$M_l' =_{\beta} M_r'$\ 。よって$(M_l',M_r')\in R_b$\\
%%  \\
%%  $T=\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}$のとき\\
%%  適切な$s,s'$について$(s,s')\in R_{\tau_2}$であると仮定する。また、$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^k_{\tau_1(\mu_{\alpha})\alpha}$、$(t, t')\in T_{\mu_{\beta}}$とする。\\
%%  示したいことは、\\
%%  $(M_l, M_r) \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}、M_l \rightarrow_{\beta} M_l'、M_r \rightarrow_{\beta} M_r'$のとき$(M_l', M_r') \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$\\
%%  $(M_l, M_r) \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$の定義から、\\
%%  $(M_l\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}, M_r\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t')\in R_{\beta}$\\
%%  $(M_l\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t, M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t')\in R_{\beta}$\\
%%  ここで、\\
%%  $M_l\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t} \rightarrow^* M_l'\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}$\\
%%  $M_r\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t' \rightarrow^* M_r'\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t'$\\
%%  また、\\
%%  $M_l\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t \rightarrow^* M_l'\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t$\\
%%  $M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t' \rightarrow^* M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t'$\\
%%  帰納法の仮定より、\\
%%  $(M_l'\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}, M_r'\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t')\in R_{\beta}$\\
%%  $(M_l'\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t, M_r'\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t')\in R_{\beta}$\\
%%  前提と$(M_l', M_r') \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$の定義から、$(M_l', M_r') \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$が言える。

\setcounter{definition}{8}
\begin{lemma}
  $(M_l', M_r') \in R_{\tau}、M_l \rightarrow_{\beta} M_l'、M_r \rightarrow_{\beta} M_r'$のとき$(M_l, M_r) \in R_{\tau}$が成り立つ。
\end{lemma}
簡約をしても論理関係は変わらないという補題である。\\
 \lbrack 証明 \rbrack\\
 $T=b$のとき$M_l =_{\beta} M_r$を示す。仮定より、$M_l = _{\beta} M_l'$\ $(M_l',M_r')\in R_b$\ 仮定より、$M_r' = _{\beta} M_r$なので$M_l =_{\beta} M_r$\ 。よって$(M_l,M_r)\in R_b$\\
 \\
 $T=\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}$のとき\\
 適切な$s,s'$について$(s,s')\in R_{\tau_2}$であると仮定する。また、$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^k_{\tau_1(\mu_{\alpha})\alpha}$、$(t, t')\in T_{\mu_{\beta}}$とする。\\
 示したいことは、\\
 $(M_l', M_r') \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}、M_l \rightarrow_{\beta} M_l'、M_r \rightarrow_{\beta} M_r'$のとき$(M_l, M_r) \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$\\
 $(M_l', M_r') \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$の定義から、\\
 $(M_l'\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t}, M_r'\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t')\in R_{\beta}$\\
 $(M_l'\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t, M_r'\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t')\in R_{\beta}$\\
 ここで、\\
 $M_l\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t} \rightarrow^* M_l'\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}$\\
 $M_r\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t' \rightarrow^* M_r'\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t'$\\
 また、\\
 $M_l\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t \rightarrow^* M_l'\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t$\\
 $M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t' \rightarrow^* M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t'$\\
 帰納法の仮定より、\\
 $(M_l\ s \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t}, M_r\ s' \ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k}{t_1}}]}}\ t')\in R_{\beta}$\\
 $(M_l\ s \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t, M_r\ s' \ \LamP{t_0}{K[\Lam{t_1}{t_1}]}\ t')\in R_{\beta}$\\
 前提と$(M_l, M_r) \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$の定義から、$(M_l, M_r) \in R_{\TypeArrow{\tau_2}{\tau_1}{\mu_{\alpha}}{\alpha}{\mu_{\beta}}{\beta}}$が言える。
\\
\setcounter{definition}{10}
\begin{lemma}
  $\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}{\mu_2}{\mu_3}$かつ$(t_1, t_1')\in T_{\tau_1(\mu_1)\tau_1'}、(t_2, t_2')\in T_{\mu_2}、$のとき\\
  $(\Cons{t_1}{t_2}, \Cons{t_1'}{t_2'})\in T_{\mu_3}$
\end{lemma}
本稿で示した補題\ref{TCompatible}について\\
Tと\textsf{compatible}の関係についての補題である。メイン定理の\textsf{control}のケースを証明する際に使う。
\lbrack 証明 \rbrack\\
(1a) $\mu_2=\Bullet$のとき\\
$t_2=t_2'=\textsf{idt}$で $\Cons{t_1}{t_2}=t_1\ \Cons{t_1'}{t_2'}=t_1'$\\
\textsf{compatible}の定義から $\mu_3 = \Trail{\tau_1}{\tau_1'}{\mu_1}$\\
仮定より、$(t_1,t_1')\in T_{\mu_3}$が示せる。\\
\\
(1b) $\mu_2=\Trail{\tau_2}{\tau_2'}{\mu_2}$のとき\\
$\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1}}{\Trail{\tau_2}{\tau_2'}{\mu_2}}{\mu_3}$より$\mu_3 = \Trail{\tau_1}{\tau_1'}{\mu_3'}$かつ$\Compatible{\Trail{\tau_2}{\tau_2'}{\mu_2}}{\mu_3'}{\mu_1}$...(A)\\
仮定より、\\
$(t_1, t_1')\in T_{\tau_1(\mu_1)\tau_1'}...(1)、(t_2, t_2')\in T_{\tau_2(\mu_2)\tau_2'}$...(B)\\
示したいのは、$(\Cons{t_1}{t_2}, \Cons{t_1'}{t_2'})\in T_{\tau_1(\mu_3')\tau_1'}$\\これを\textsf{cons}の定義に従って展開すると次のようになる。\\
$(\Lam{v}{\Lam{t'}{t_1\,v\,(\Cons{t_2}{t'})}}, \Lam{v}{\Lam{t'}{t_1'\,v\,(\Cons{t_2'}{t'})}})\in T_{\tau_1(\mu_3')\tau_1'}$\\
Tの定義より、\\
$(V_1,V_1')\in R_{\tau_1}$...(2)と$(t_3,t_3')\in T_{\mu_3'}$...(C)を満たし、$(t_1\ V_1\ (\Cons{t_2}{t_3}),t_1'\ V_1'\ (\Cons{t_2'}{t_3'}))$となる。\\
(1),(2)より$(\Cons{t_2}{t_3},\Cons{t_2'}{t_3'})\in T_{\mu_1}$を示せば良い。\\
\\
次に(A),(B),(C)を利用して$(\Cons{t_2}{t_3},\Cons{t_2'}{t_3'})\in T_{\mu_1}$を示す。\\
(2a) $\mu_3'=\Bullet$のとき\\
$t_3=t_3'=\textsf{idt}$で $\Cons{t_2}{t_3}=t_2\ \Cons{t_2'}{t_3'}=t_2'$\\
\textsf{compatible}の定義から $\mu_1 = \Trail{\tau_2}{\tau_2'}{\mu_2}$\\
仮定より、$(t_2,t_2')\in T_{\mu_1}$が示せる。\\
\\
(2b) $\mu_3'=\Trail{\tau_3}{\tau_3'}{\mu_3'}$のとき\\
$\Compatible{\Trail{\tau_2}{\tau_2'}{\mu_2}}{\Trail{\tau_3}{\tau_3'}{\mu_3'}}{\mu_1}$より$\mu_1 = \Trail{\tau_2}{\tau_2'}{\mu_1'}$かつ$\Compatible{\Trail{\tau_3}{\tau_3'}{\mu_3'}}{\mu_1'}{\mu_2}$...(D)\\
仮定より、\\
$(t_2, t_2')\in T_{\tau_2(\mu_2)\tau_2'}...(3)、(t_3, t_3')\in T_{\tau_3(\mu_3)\tau_3'}$...(E)\\
示したいのは、$(\Cons{t_2}{t_3}, \Cons{t_2'}{t_3'})\in T_{\tau_2(\mu_1')\tau_2'}$\\これを\textsf{cons}の定義に従って展開すると次のようになる。\\
$(\Lam{v}{\Lam{t'}{t_2\,v\,(\Cons{t_3}{t'})}}, \Lam{v}{\Lam{t'}{t_2'\,v\,(\Cons{t_3'}{t'})}})\in T_{\tau_2(\mu_1')\tau_2'}$\\
Tの定義より、\\
$(V_2,V_2')\in R_{\tau_2}$...(4)と$(t_1,t_1')\in T_{\mu_1'}$...(F)を満たし、$(t_2\ V_2\ (\Cons{t_3}{t_1}),t_2'\ V_2'\ (\Cons{t_3'}{t_1'}))$となる。\\
(3),(4)より$(\Cons{t_3}{t_1},\Cons{t_3'}{t_1'})\in T_{\mu_2}$を示せば良い。\\
\\
次に(D),(E),(F)を利用して$(\Cons{t_3}{t_1},\Cons{t_3'}{t_1'})\in T_{\mu_2}$を示す。\\
(3a) $\mu_1'=\Bullet$のとき\\
$t_1=t_1'=\textsf{idt}$で $\Cons{t_3}{t_1}=t_3\ \Cons{t_3'}{t_1'}=t_3'$\\
\textsf{compatible}の定義から $\mu_2 = \Trail{\tau_3}{\tau_3'}{\mu_3}$\\
仮定より、$(t_3,t_3')\in T_{\mu_2}$が示せる。\\
\\
(3b) $\mu_1'=\Trail{\tau_1}{\tau_1'}{\mu_1'}$のとき\\
$\Compatible{\Trail{\tau_3}{\tau_3'}{\mu_3'}}{\Trail{\tau_1}{\tau_1'}{\mu_1'}}{\mu_2}$より$\mu_2 = \Trail{\tau_3}{\tau_3'}{\mu_2'}$かつ$\Compatible{\Trail{\tau_1}{\tau_1'}{\mu_1'}}{\mu_2'}{\mu_3'}$...(G)\\
仮定より、\\
$(t_3, t_3')\in T_{\tau_3(\mu_3')\tau_3'}...(5)、(t_1, t_1')\in T_{\tau_1(\mu_1')\tau_1'}$...(H)\\
示したいのは、$(\Cons{t_3}{t_1}, \Cons{t_3'}{t_1'})\in T_{\tau_3(\mu_2')\tau_3'}$\\これを\textsf{cons}の定義に従って展開すると次のようになる。\\
$(\Lam{v}{\Lam{t'}{t_3\,v\,(\Cons{t_1}{t'})}}, \Lam{v}{\Lam{t'}{t_3'\,v\,(\Cons{t_1'}{t'})}})\in T_{\tau_3(\mu_2')\tau_3'}$\\
Tの定義より、\\
$(V_3,V_3')\in R_{\tau_3}$...(6)と$(t_2,t_2')\in T_{\mu_2'}$...(I)を満たし、$(t_3\ V_3\ (\Cons{t_1}{t_2}),t_3'\ V_3'\ (\Cons{t_1'}{t_2'}))$となる。\\
(3),(4)より$(\Cons{t_1}{t_2},\Cons{t_1'}{t_2'})\in T_{\mu_3'}$を示せば良い。\\
(G),(H),(I)と帰納法の仮定より、$(\Cons{t_1}{t_2},\Cons{t_1'}{t_2'})\in T_{\mu_3'}$が示せる。
\\
\setcounter{definition}{9}
\begin{lemma}
  コンテキスト$\Lam{v_0}{\Lam{t_0}{K[f]}}\ =\ \Lam{v_0}{\Lam{t_0}{\Idk\ v_0\ (f\ t_0)}}$は$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\beta(\mu_{id})\beta'}$を満たす。
\label{IdkContext}
\end{lemma}
この補題はcontrolとpromptのケースで使用する。
\\
\lbrack 証明 \rbrack\\
任意の$(V,V')\in R_{\beta}$と$(t_1,t_1')\in T_{\mu_{id}}$について\\
(A)\ $(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ (\Cons{k}{t_1}),
\qquad \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V\ t_1')\in R_{\beta'}$と\\
(B)\ $(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ t_1,
\qquad \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ t_1')\in R_{\beta'}$を示せば良い。\\
\\
(A)コンテキストを代入して以下のようにする。\\
$(\LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ t_0}}\ V\ (\Cons{k}{t_1}),
\LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ (\Cons{k'}{t_0})}}\ V\ t_1')\in R_{\beta'}$\\
さらに補題\ref{Reduction2}より、簡約して$(\Idk\ V\ (\Cons{k}{t_1}),\Idk\ V'\ (\Cons{k'}{t_1'}))\in R_{\beta'}$を示す。\\
\\
(1)$t_1=\Bullet$の時\\
$(k\ V\ \Idt,k' V'\ \Idt)\in R_{\beta'}$を示す。
ここで$\mu_{id}=\Bullet$なので\textsf{id-cont-type}より$\beta=\beta'$となる。\\
$(k,k')\in k_{\beta(\mu_{id})\beta'}$より$(V,V')\in R_{\beta}$と$(t_1,t_1')\in T_{\mu_{id}}$について\\
$(k\ V\ \Idt,k' V'\ \Idt)\in R_{\beta'}$となる。\\
\\
(2)$t_1 \neq \Bullet$の時\\
$(k\ V\ t,k' V'\ t')\in R_{\beta'}$を示す。
$(k,k')\in k_{\beta(\mu_{id})\beta'}$より$(V,V')\in R_{\beta}$と$(t_1,t_1')\in T_{\mu_{id}}$について\\
$(k\ V\ \Idt,k' V'\ \Idt)\in R_{\beta'}$となり示せた。\\
\\
(B)\ コンテキストを代入して以下のようにする。\\
$(\LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ t_0}}\ V\ t_1,
\LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ t_0}}\ V\ t_1')\in R_{\beta'}$\\
さらに補題\ref{Reduction2}より、簡約して$(\Idk\ V\ t_1,\Idk\ V'\ t_1')\in R_{\beta'}$を示す。\\
\\
(1)$t_1=\Bullet$の時\\
$(V,V')\in R_{\beta'}$を示す。\\
ここで$\mu_{id}=\Bullet$なので\textsf{id-cont-type}より$\beta=\beta'$となるため示せた。\\
\\
(2)$t_1 \neq \Bullet$の時\\
$(t_1\ V\ \Idt,t_1' V'\ \Idt)\in R_{\beta'}$を示す。\\
\textsf{id-cont-type}より$\mu_{id}=\Trail{\beta}{\beta'}{\Bullet}$\\
よって$(V,V')\in R_{\beta}$と$(\Idt,\Idt)\in T_{\Bullet}$について$(t_1\ V\ \Idt,t_1' V'\ \Idt)\in R_{\beta'}$となる。

\subsection*{B.証明}

\setcounter{definition}{7}
\begin{theorem}[メイン定理]
  $x_i:\tau_i \vdash e:\tau \TrailsType{\alpha}{\beta} \TrailType{\beta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$を満たす$k,k'$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\beta}}$を満たす任意の$t, t'$とについて、\\
  $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \Cons{k}{t}, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\beta}$と\\
  $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\beta}$が成り立つ。
\end{theorem}
\lbrack 証明 \rbrack\\\\
%%%%%%%%%%%%%%%%%%%%%%%%%%    VAR    %%%%%%%%%%%%%%%%%%%%%%%%%%    
\textbf{1.Varの場合}\\
型規則
\[
\begin{array}{c}
\infer[\TVar]
      {\JudgeTrail{\Gamma}{x}{\tau}{\TrailsType{\alpha}{\alpha}}
                                   {\TrailType{\alpha}}}
      {\Gamma(x)=\tau}
\end{array}
\]
\\
示すことは以下のようになる。\\
$x_i:\tau_i\ ,\ x:\tau\vdash e:\tau \TrailType{\alpha} \TrailType{\alpha}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}\ \ (v,v')\in R_{\tau}$かつ$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$を満たす$k,k'$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\alpha}}$を満たす任意の$t, t'$について、\\
  (A)\ $(\rho[x \rightarrow v] \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t}, \rho[x \rightarrow v'] \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\alpha}$と\\
  (B)\ $(\rho[x \rightarrow v] \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho[x \rightarrow v'] \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\alpha}$が成り立つ。\\
\\
(A)CPS変換を展開して、\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ v\ \ConsP{k}{t}, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ v'\ t')\in R_{\mu_{\alpha}}$を示す。\\
ここでコンテキスト$K$は$K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすので、$(V,V')\in R_{\tau}$を満たす$V,V'$と$(t_1, t_1')\in T_{\mu_{\alpha}}$を満たす$t_1, t_1'$について\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \ConsP{k}{t_1}, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ t_1')\in R_{\mu_{\alpha}}$が言える。\\
前提より、$(v,v')\in R_{\tau}$ $(t, t') \in T_{\mu_{\alpha}}$なので示せた。\\
\\
(B)CPS変換を展開して、\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ v\ t, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ v'\ t')\in R_{\mu_{\alpha}}$を示す。\\
ここでコンテキスト$K$は$K^k_{\tau_1(\mu_{\alpha})\alpha}$を満たすので、$(V,V')\in R_{\tau}$を満たす$V,V'$と$(t_1, t_1')\in T_{\mu_{\alpha}}$を満たす$t_1, t_1'$について\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ t_1, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V'\ t_1')\in R_{\mu_{\alpha}}$が言える。\\
前提より、$(v,v')\in R_{\tau}$ $(t, t') \in T_{\mu_{\alpha}}$なので示せた。\\
\\
%%%%%%%%%%%%%%%%%%%%%%%%%%    FUN    %%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{2.Funの場合}\\
型規則
\[
\begin{array}{c}
\infer[\TFun]
      {\JudgeTrail{\Gamma}{\DLam{x}{e}}
                  {\ArrowTrailP{\tau_2}{\tau_1}
                               {\TrailsType{\alpha}{\beta}}
                               {\TrailType{\beta}}}
                  {\TrailType{\gamma}}
                  {\TrailType{\gamma}}}
      {\JudgeTrail{\Gamma,x:\tau_2}{e}{\tau_1}
                  {\TrailsType{\alpha}{\beta}}
                  {\TrailType{\beta}}}
\end{array}
\]
\\
示すことは以下のようになる。\\
$x_i:\tau_i \vdash \Lam{x}{e}:\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}, \TrailType{\gamma}, \TrailType{\gamma}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$を満たす$k,k'$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$を満たすような任意のコンテキスト$K$と、$(t_2, t_2') \in T_{\mu_{\gamma}}$を満たす任意の$t, t'$について、\\
  (A)\ $(\rho \CPSTh{\Lam{x}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t_2}, \rho \CPSTh{\Lam{x}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_2')\in R_{\gamma}$と\\
  (B)\ $(\rho \CPSTh{\Lam{x}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2, \rho \CPSTh{\Lam{x}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_2')\in R_{\gamma}$が成り立つ。\\
\\
(A)CPS変換を展開して、\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}
          \LamP{v}{\Lam{k'}{\Lam{t'}{\CPS{e}{\rho[\Change{x}{v}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{k'}{a}}{t''}}}}{t'}}}}\ (\ConsP{k}{t_2}),\\
  (\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}
          \LamP{v}{\Lam{k'}{\Lam{t'}{\CPS{e}{\rho[\Change{x}{v}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{k'}{a}}{t''}}}}{t'}}}}\ t_2')\in R_{\gamma}$を示したい。\\
コンテキスト$K$は$K^{kk'}_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$を満たすので、\\
$(V,V')\in R_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}}$を満たす$V,V'$ と $(t_2, t_2') \in T_{\mu_{\gamma}}$ を満たす $t_2, t_2'$ について\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \Cons{k}{t_2}, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ t_2')\in R_{\gamma}$となる。\\
つまり、\\
      $(\LamP{v}{\Lam{k'}{\Lam{t'}{\CPS{e}{\rho[\Change{x}{v}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{k'}{a}}{t''}}}}{t'}}}},\\
         \LamP{v}{\Lam{k'}{\Lam{t'}{\CPS{e}{\rho[\Change{x}{v}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{k'}{a}}{t''}}}}{t'}}}})\in R_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}}$を示せば良い。\\
\\
$R_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}}$の定義から、\\
任意の$(s,s')\in R_{\tau_2}$と$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$と$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすコンテキストと
$(t_3,t_3')\in T_{\mu_{\beta}}$を満たす$t_3, t_3'$について次の2つを示せば良い。\\
(C)\ $(\CPS{e}{\rho[\Change{x}{s}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}}{(\ConsP{k}{t_3})}),\\
  \qquad \CPS{e}{\rho[\Change{x}{s'}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{a}}{t''}}}}{t_3'}))\in R_{\beta}$\\
\\
(D)\ $(\CPS{e}{\rho[\Change{x}{s}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}}{t_3}),\\
  \qquad \CPS{e}{\rho[\Change{x}{s'}]}
           {\LamP{a}{\Lam{t''}
               {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}}{t_3'}))\in R_{\beta}$\\
\\
$e$に対しての帰納法の仮定より、\\
$x_i:\tau_i, x:\tau_2 \vdash e:\tau_1 \TrailType{\alpha} \TrailType{\beta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i} (v, v')\in R_{\tau_2}$かつ$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t_3, t_3') \in T_{\mu_{\beta}}$を満たす任意の$t_3, t_3'$について、\\
(C)'\ $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ \ConsP{k}{t_3}, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_3')\in R_{\gamma}$と\\
(D)'\ $(\rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_3, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_3')\in R_{\gamma}$が成り立つ。\\
帰納法の仮定を使うために、\\
$(\LamP{a}{\Lam{t''}
  {\App{\App{\LamP{v_0}{\Lam{t_0}{K[]}}}{a}}{t''}}},
  \LamP{a}{\Lam{t''}
    {\App{\App{\LamP{v_0}{\Lam{t_0}{K[]}}}{a}}{t''}}},)\in K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を示す。\\
  \\
  $K$の定義より、\\
  $(V_1, V_1')\in R_{\tau_1}$を満たす$V_1,V_1'$と$(t,t')\in T_{\mu_{\alpha}}$を満たす$t,t'$について\\
  (E)\ $(\LamP{a}{\Lam{t''}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}\ V_1\ (\Cons{k}{t})),\\
  \qquad \LamP{a}{\Lam{t''}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{a}}{t''}}}\ V_1\ t')\in R_{\alpha}$\\
  (F)\ $(\LamP{a}{\Lam{t''}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}\ V_1\ t),\\
  \qquad \LamP{a}{\Lam{t''}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{a}}{t''}}}\ V_1\ t')\in R_{\alpha}$\\
  を示せば良い。\\
  \\
  補題\ref{Reduction2}より、簡約しても論理関係は変わらないので\\
  (E)\ $(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V_1\ (\Cons{k}{t}), \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V_1'\ t')$\\
  (F)\ $(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V_1\ t, \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V_1'\ t')$\\
  を示せば良い。\\
  ここで、$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たしており、\\
  $(V_1, V_1')\in R_{\tau_1} (t,t')\in T_{\mu_{\alpha}}$より(E),(F)が示せる。\\
  \\
  (B)も(A)と同様に示せる。
\\
\\  
%%%%%%%%%%%%%%%%%%%%%%%%%%    APP    %%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{3.Appの場合}\\
型規則  
\[
\begin{array}{c}
  \infer[\TApp]
      {\JudgeTrail{\Gamma}{\DApp{e_1}{e_2}}
                  {\tau_1}{\TrailsType{\alpha}{\delta}}{\TrailType{\delta}}}
      {\JudgeTrail{\Gamma}{e_1}
                  {\ArrowTrailP{\tau_2}{\tau_1}{\TrailsType{\alpha}{\beta}}
                                               {\TrailType{\beta}}}
                  {\TrailsType{\gamma}{\delta}}
                  {\TrailType{\delta}}
      &\JudgeTrail{\Gamma}{e_2}{\tau_2}{\TrailsType{\beta}{\gamma}}{\TrailType{\gamma}}}
\end{array}
\]
\\
示すことは以下のようになる。\\
$x_i:\tau_i\ \vdash e:\tau_1 \TrailType{\alpha} \TrailType{\delta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ\\
$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\delta}}$を満たす任意の$t, t'$と任意の$k$について、\\
  (A)\ $(\rho \CPSTh{e_1\ e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t}), \rho \CPSTh{e_1\ e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\delta}$と\\
  (B)\ $(\rho \CPSTh{e_1\ e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e_1\ e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\delta}$が成り立つ。\\
\\
それぞれCPS変換を展開して\\
  (A)\ $(\CPS{e_1}{\rho}
      {\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}}{(\Cons{k}{t})},\\
      \qquad \CPS{e_1}{\rho}
      {\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}}{t_2}}}}{t_1}}}}{t'}\in R_{\delta}$\\
 \\
  (B)\ $(\CPS{e_1}{\rho}
      {\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}}{t},\\
      \qquad \CPS{e_1}{\rho}
      {\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}}{t'}\in R_{\delta}$\\
      \\
$e_1$についての帰納法の仮定より、\\
$(k,k')\in k_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\delta}}$を満たす任意の$t, t'$について、\\
  (A)'\ $(\rho \CPSTh{e_1} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t}), \rho \CPSTh{e_1} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\delta}$と\\
  (B)'\ $(\rho \CPSTh{e_1} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e_1} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\delta}$が成り立つ。\\
\\
そこで、\\
$(\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[]}}}}{t_2}}}}{t_1}}},\\
 \LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[]}}}}{t_2}}}}{t_1}}})\in K^{kk'}_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$\\
 を示せば良い。\\
 \\
 $K^{kk'}_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}} \TrailType{\gamma}}$の定義から、\\
 $(V_1,V_1')\in R_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}}$を満たす$V_1,V_1'$と$(t_3,t_3')\in T_{\mu_{\gamma}}$を満たす$t_3,t_3'$について\\
 \\
 (C)\ $(\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}\ V_1\ (\Cons{k}{t_3}),\\
   \qquad    \LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}}{t_2}}}}{t_1}}}\ V_1'\ t_3')\in R_{\gamma}$\\
   \\
 (D)\ $(\LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}\ V_1\ t_3,\\
   \qquad    \LamP{v_1}{\Lam{t_1}{\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{v_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_1}}}\ V_1'\ t_3')\in R_{\gamma}$\\
   \\
   また、補題\ref{Reduction2}より簡約して\\
 (C)\ $(\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{(\Cons{k}{t_3})},\\
   \qquad  \CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1'}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}}{t_2}}}}{t_3'})\in R_{\gamma}$\\
            \\
 (D)\ $(\CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_3},\\
   \qquad  \CPS{e_2}{\rho}
            {\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1'}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}}{t_3'})\in R_{\gamma}$\\
  を示せば良い。\\
  \\
  $e_2$についての帰納法の仮定より、\\
  $(k,k')\in k_{\tau_2(\mu_{\beta})\beta}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_2(\mu_{\beta})\beta}$を満たすような任意のコンテキスト$K$と、$(t_3, t_3') \in T_{\mu_{\gamma}}$を満たす任意の$t, t'$と任意の$k$について、\\
  (C)'\ $(\rho \CPSTh{e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t_3}), \rho \CPSTh{e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_3')\in R_{\gamma}$と\\
  (D)'\ $(\rho \CPSTh{e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_3, \rho \CPSTh{e_2} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_3')\in R_{\gamma}$が成り立つ。\\
  \\
  \\
  帰納法の仮定を使って(C),(D)を導出するために以下を示す。\\
  $(\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[]}}}}{t_2}}},\\
   \LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[]}}}}{t_2}}}\in K^{kk'}_{\tau_2(\mu_{\beta})\beta}$\\
   \\
   $K^{kk'}_{\tau_2(\mu_{\beta})\beta}$の定義より、以下を示す。\\
   $(V_2,V_2')\in R_{\tau_2}$を満たす任意の$V_2,V_2'$と $(t_4, t_4')\in T_{\mu_{\beta}}$を満たす任意の$t_4, t_4'$について\\
   (E)\ $(\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}\ V_2\ (\Cons{k}{t_4}),\\
   \qquad \LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}}{t_2}}}\ V_2'\ t_4')$\\
   \\
   (F)\ $(\LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}\ V_2\ t_4,\\
   \qquad \LamP{v_2}{\Lam{t_2}
                {\AppP{\AppP{\AppP{V_1}{v_2}}
                    {\LamP{v_0}{\Lam{t_0}
                        {K[\Lam{t_1}{t_1}]}}}}{t_2}}}\ V_2'\ t_4')$\\
   \\
   補題\ref{Reduction2}より、簡約して
   (E)\ $(V_1\ V_2\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t_4}),\\
   \qquad V_1'\ V_2'\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_4')$\\
   \\
   (F)\ $(V_1\ V_2\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_4,\\
   \qquad V_1'\ V_2'\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_4')$\\
   を示せば良い。\\
   \\
   ここで、$V_1,V_1'$は$(V_1,V_1')\in R_{\ArrowTrailP{\tau_2}{\tau_1}{\TrailType{\alpha}}{\TrailType{\beta}}}$を満たしている。\\
   この定義より、$(V_2,V_2')\in R_{\tau_2}$と\\
   $(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau_1(\mu_{\alpha})\alpha}$を満たしているコンテキスト$K$と$(t_4, t_4')\in T_{\mu_{\beta}}$について、(E),(F)が導出できる。\\
\\
\\
%%%%%%%%%%%%%%%%%%%%%%%%%%    CONTROL    %%%%%%%%%%%%%%%%%%%%%%%%%%
\textbf{3.Controlの場合}\\
型規則
\[
\begin{array}{c}
  \infer[\TControl]
      {\JudgeTrail{\Gamma}{\DControl{k}{e}}{\tau}
                  {\TrailsType{\alpha}{\beta}}
                  {\TrailType{\beta}}}
      {\begin{array}{c}
       \IsIdTrail{\gamma}{\gamma'}{\MuId}\\
       \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0}\quad
       \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha}\\
       \JudgeTrail{\Gamma,k:\ArrowTrail{\tau}{t_1}
                              {\TType{\mu_1}{t_2}}
                              {\TType{\mu_2}{\alpha}}}
                  {e}{\gamma}
                  {\TsType{\MuId}{\gamma'}{\Bullet}}
                  {\TType{\Bullet}{\beta}}
       \end{array}}
\end{array}
\]
\\
示すことは以下のようになる。\\
$x_i:\tau_i\ \vdash \Control{k}{e}:\tau \TrailType{\alpha} \TrailType{\beta}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ\\
$(k,k')\in k_{\tau(\mu_{\alpha})\alpha}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t_l, t_r) \in T_{\mu_{\beta}}$を満たす任意の$t, t'$と任意の$k$について、\\
  (A)\ $(\rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t_l}), \rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t_r)\in R_{\beta}$と\\
(B)\ $(\rho \CPSTh{\Control{c}{e}}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_l, \rho \CPSTh{\Control{c}{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t_r)\in R_{\beta}$が成り立つ。\\
\\
(A)について、\\
CPS変換をすると、\\
$(\DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\DLet{t''}{\DAppend{\Cons{k}{t_l}}{\ConsP{k'}{t'}}}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{t''}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}},\\
  \DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\DLet{t''}{\DAppend{t_r}{\ConsP{k'}{t'}}}{\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{t''}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}})\\
      \in R_{\beta}$となる。\\
\\
また、$\beta_{\Omega}$より$t''$を代入して\\
(A)\ $(\DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\DAppend{\ConsP{k}{t_l}}{\ConsP{k'}{t'}}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}},\\
\qquad   \DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}})
      \in R_{\beta}$\\
\\
ここで、Agdaで示した\textsf{assoc}より$\DAppend{\ConsP{k}{t_l}}{\ConsP{k'}{t'}} =_{\beta} \Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})$である。\\
$(\DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}},\\
   \DLet{x'}
      {\Lam{v}{\Lam{k'}{\Lam{t'}
        {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}}}
      {\CPS{e}{\rho[\Change{c}{x'}]}{\Idk}{\Idt}})
      \in R_{\beta}$\\
      左右の$x'$の中身をそれぞれ$X,Y$とおくと、\\
      $(\CPS{e}{\rho[\Change{c}{X}]}{\Idk}{\Idt},\CPS{e}{\rho[\Change{c}{Y}]}{\Idk}{\Idt})\in R_{\beta}$を示せば良い。\\
\\
$e$に対しての帰納法の仮定より、\\
$x_i:\tau_i\ c:\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha \vdash e : \gamma (\mu_{id}) \gamma' (\Bullet) \beta$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$で\\
$(k,k')\in k_{\gamma (\mu_{id}) \gamma'}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\gamma (\mu_{id}) \gamma'}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\Bullet}$を満たす任意の$t, t'$について、\\
$(\rho \CPSTh{e}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\beta}$が成り立つ。\\
\\
$\Lam{v_0}{\Lam{t_0}{K[f]}}\ =\ \Lam{v_0}{\Lam{t_0}{\Idk\ v_0\ (f\ t_0)}}$\\
上のコンテキストは$K^{kk'}_{\gamma (\mu_{id}) \gamma'}$を満たし(補題\ref{IdkContext})、$(t, t') \in T_{\Bullet}$より$t=t'=\Idt$なので
帰納法の仮定で(A)を導くには、$(X,Y)\in R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$を示す。\\
$(\Lam{v}{\Lam{k'}{\Lam{t'}
    {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{\Cons{k}{(\DAppend{t_l}{\ConsP{k'}{t'}}})}}}},\\
  \Lam{v}{\Lam{k'}{\Lam{t'}
      {\App{\App{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{\DAppend{t_r}{\ConsP{k'}{t'}}}}}})\in R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$\\
\\
$R_{\tau \rightarrow t_1, (\mu_1) t_2 (\mu_2) \alpha}$の定義から\\
$(V,V')\in R_{\tau}$と$(k_1,k_1')\in k_{t_1 (\mu_1) t_2}$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in K^{k_1k_1'}_{t_1 (\mu_1) t_2}$を満たすコンテキスト$K_1$と$(t_{l2},t_{r2})\in T_{\mu_1}$について\\
(C)\ $(X\ V\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ \ConsP{k_1}{t_{l2}},Y\ V'\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ t_{r2})\in R_{\alpha}$\\
(D)\ $(X\ V\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ t_{l2},Y\ V'\ \Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ t_{r2})\in R_{\alpha}$を示せば良い。\\
\\
(C)について\\
X,Yを代入して補題\ref{Reduction2}より簡約すると\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \Cons{k}{(\DAppend{t_l}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}{\ConsP{k_1}{t_{l2}}}}}),\\
\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ \DAppend{t_r}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}{t_{r2}}})\in R_{\alpha}$を示す。\\
\\
$(\LamP{v_0}{\Lam{t_0}{K[]}},\LamP{v_0}{\Lam{t_0}{K[]}})\in K^{kk'}_{\tau(\mu_{\alpha})\alpha}$を満たしているから\\
$(V,V')\in R_{\tau}$と$(t, t')\in T_{\mu_{\alpha}}$について\\
$(\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ V\ \ConsP{k}{t},
\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ V'\ t')\in R_{\alpha}$\\
\\
そこで、\\
(E)\ $(\DAppend{t_l}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}{\ConsP{k_1}{t_{l2}}}},
\DAppend{t_r}{\ConsP{\Lam{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}{t_{r2}}})\in T_{\mu_{\alpha}}$を示す。\\
\\
ここで、$\Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0}\quad \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha}$である事を考慮して、\\
次のように$trail$を考える。\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%trail設定%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
$\mu_0 = \Trail{t_1}{t_2}{\mu_0}\quad \mu_2 = \Trail{\epsilon}{\epsilon'}{\mu'}$\\
$\mu_{\beta} = \Trail{\delta}{\delta'}{\mu}\quad \mu_{\alpha} = \Trail{\delta}{\delta'}{\mu_{\alpha}}$\\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%trail設定%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\\
(E)の$::$を展開する。\\
(E)\ $(\DAppend{t_l}{\Lam{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}},\\
\qquad \DAppend{t_r}{\Lam{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}})\in T_{\mu_{\alpha}}$\\
次に$@$を展開する。また、$\mu_{\alpha} = \Trail{\delta}{\delta'}{\mu_{\alpha}}$なので\\
(E)\ $(\Lam{v_2}{\Lam{t_2'}{t_l\ v_2\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_2'}}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{t_r\ v_2\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_2'}}})\in T_{\delta(\mu_{\alpha})\delta'}$\\
\\
$T_{\delta(\mu_{\alpha})\delta'}$の定義から\\
$(V_{delta},V_{delta}')\in R_{\delta}$を満たす$V,V'$と$(t_3, t_4)\in T_{\mu_{\alpha}}$を満たす$t_3, t_4$について\\
$(t_l\ V_{delta}\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_3},\\
t_r\ V_{delta}'\ \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_4})
\in R_{\delta'}$を示せば良い。\\
\\
ここで、$(t_l, t_r)\in T_{\mu_{\beta}}$つまり$(t_l, t_r)\in T_{\delta{\mu}\delta'}$なので定義より、\\
$(V_{delta},V_{delta}')\in R_{\delta}$を満たす$V,V'$とと$(t_{\mu}, t_{\mu}')\in T_{\mu}$を満たす$t_{\mu}, t_{\mu'}$について\\
$(t_l\ V_{delta}\ t_{\mu},t_r\ V_{delta}'\ t_{\mu}')\in R_{\delta'}$となるから\\
\\
(F)\ $(\Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}{t_3},\\
\qquad \Cons{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}{t_4})
\in T_{\mu}$を示せば良い。\\
\\
ここで、(F)の$::$を展開し\\
(F)\ $(\Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}\ v_2\ \ConsP{t_3}{t_2'}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}\ v_2\ \ConsP{t_4}{t_2'}})\in T_{\mu}$となる。\\
\\
$\mu$について、\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\mu_\beta}{\mu_0}{\mu_\alpha} &=& \Compatible{\Trail{\delta}{\delta'}{\mu}}{\Trail{t_1}{\mu_0}{t_2}}{\Trail{\delta}{\mu_{\alpha}}{\delta'}}\\
  &=& \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\mu}
\end{array}
\]
\caption{\textsf{comptible}展開1}
\label{Compatible1}
\end{figure}
より$\mu=\Trail{t_1}{t_2}{\mu'}$と置くことができるので(F)は次のようになる。\\
\\
(F)\ $(\Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}}\ v_1\ \Cons{\ConsP{k_1}{t_{l2}}}{t_1'}}}\ v_2\ \ConsP{t_3}{t_2'}},\\
\qquad \Lam{v_2}{\Lam{t_2'}{\LamP{v_1}{\Lam{t_1'}{\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}}\ v_1\ \ConsP{t_{r2}}{t_1'}}}\ v_2\ \ConsP{t_4}{t_2'}})\in T_{t_1(\mu')t_2}$を示す。\\
定義より、\\
$(V_1,V_1')\in R_{t_1}$と$(t_{\mu_2},t_{\mu_2}')\in T_{\mu'}$について\\
(G)\ $(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \Cons{\ConsP{k_1}{t_{l2}}}{\ConsP{t_3}{t_{\mu_2}}},\\
\qquad \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ \Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in R_{t_2}$を示せば良い。\\
\\
ここで、\textsf{cons-assoc}より、$\Cons{\ConsP{k_1}{t_{l2}}}{\ConsP{t_3}{t_{\mu_2}}} =_{\beta} \Cons{k_1}{\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}}}$なので\\
(G)\ $(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \Cons{k_1}{\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}}},\\
\qquad \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ \Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in R_{t_2}$を示せば良い。\\
\\
ここで、$K_1$が$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in K^{k_1k_1'}_{t_1 (\mu_1) t_2}$を満たすので、\\
$(V_1,V_1')\in R_{t_1}$と$(t,t')\in T_{\mu_1}$について\\
$(\LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{t_1}]}}\ V_1\ \ConsP{k_1}{t}, \LamP{v_0}{\Lam{t_0}{K_1[\Lam{t_1}{\Cons{k_1'}{t_1}}]}}\ V_1'\ t)
\in R_{\tau_2}$が言える。\\
\\
つまり、(H)\ $(\ConsP{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}},\Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in T_{\mu_1}$を示せば良い。
\\
ここで、\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\mu_0} &=& \Compatible{\Trail{t_1}{t_2}{\mu_1}}{\mu_2}{\Trail{t_1}{t_2}{\mu_0}}\\
  &=& \Compatible{\mu_2}{\mu_0}{\mu_1}
\end{array}
\]
\caption{\textsf{comptible}展開2}
\label{Compatible2}
\end{figure}\\
\\
また、図\ref{Compatible1}の続きから\\
\begin{figure}[h]
\[
\begin{array}{lcl}
  \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\mu} &=& \Compatible{\Trail{t_1}{\mu_0}{t_2}}{\mu_{\alpha}}{\Trail{t_1}{t_2}{\mu'}}\\
  &=& \Compatible{\mu_{\alpha}}{\mu'}{\mu_0}
\end{array}
\]
\caption{\textsf{comptible}展開3}
\label{Compatible3}
\end{figure}\\
\\
(H)を示す。\\
$(t_3,t_4)\in T_{\mu_{\alpha}}\ (t_{\mu_2},t_{\mu_2}')\in T_{\mu'}$で図\ref{Compatible3}より$\Compatible{\mu_{\alpha}}{\mu'}{\mu_0}$\\
補題\ref{TCompatible}より$(\Cons{t_3}{t_{\mu_2}},\Cons{t_4}{t_{\mu_2}'})\in T_{\mu_0}$\\
また、$(t_{l2},t_{r2})\in T_{\mu_2}$で図\ref{Compatible2}より$\Compatible{\mu_2}{\mu_0}{\mu_1}$なので\\
補題\ref{TCompatible}より$(\Cons{t_{l2}}{\ConsP{t_3}{t_{\mu_2}}},\Cons{t_{r2}}{\ConsP{t_4}{t_{\mu_2}'}})\in T_{\mu_1}$となる。\\
これで(H)が示せた。\\
(B),(D)についても同様に示す。\\
\\
\\
%%%%%%%%%%%%%%%%%%%%%%%%%%    PROMPT    %%%%%%%%%%%%%%%%%%%%%%%%%%   
\textbf{4.Promptの場合}\\
型規則
\[
\begin{array}{c}
  \infer[\TPrompt]
      {\JudgeTrail{\Gamma}{\DReset{e}}{\tau}{\TrailsType{\alpha}{\alpha}}
                                            {\TrailType{\alpha}}}
      {\IsIdTrail{\beta}{\beta'}{\MuId}
      &\JudgeTrail{\Gamma}{e}{\beta}
                  {\TsType{\MuId}{\beta'}{\Bullet}}
                  {\TType{\Bullet}{\tau}}}
\end{array}
\]
\\
示すことは以下のようになる。\\
$x_i:\tau_i\ \vdash \Prompt{e}:\tau \TrailType{\alpha} \TrailType{\alpha}$であり、かつ各$v_i$が$\vdash v_i:\tau_i$かつ$(v_i,v_i') \in R_{\tau_i}$かつ\\
$(k,k')\in k_{\tau_1(\mu_{\alpha})\alpha}$を満たす$k,k'$かつ$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau(\mu_{\alpha})\alpha}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\mu_{\alpha}}$を満たす任意の$t, t'$について、\\
  (A)\ $(\rho \CPSTh{\Prompt{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ (\Cons{k}{t}), \rho \CPSTh{\Prompt{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}\ t')\in R_{\alpha}$と\\
(B)\ $(\rho \CPSTh{\Prompt{e}}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{\Prompt{e}} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\alpha}$が成り立つ。\\
\\
それぞれのCPS変換を展開して、\\
(A)\ $(\DLet{v}{\CPS{e}{\rho}{\Idk}{\Idt}}{\SApp{\SApp{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{(\Cons{k}{t})}},\\
\qquad   \DLet{v}{\CPS{e}{\rho}{\Idk}{\Idt}}{\SApp{\SApp{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{\Cons{k'}{t_1}}]}}}{v}}{t'}})\in R_{\alpha}$ \\
\\
(B)\ $(\DLet{v}{\CPS{e}{\rho}{\Idk}{\Idt}}{\SApp{\SApp{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{t}},\\
\qquad  \DLet{v}{\CPS{e}{\rho}{\Idk}{\Idt}}{\SApp{\SApp{\LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}}{v}}{t'}})\in R_{\alpha}$ \\
\\
$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\tau(\mu_{\alpha})\alpha}$より、\\
(C)\ $(\CPS{e}{\rho}{\Idk}{\Idt},\CPS{e}{\rho}{\Idk}{\Idt})\in R_{\tau}$を示せば良い。\\
\\
$e$に対する帰納法の仮定より、\\
$(k,k')\in k_{\beta(\mu_{id})\beta'}$を満たす$k,k'$と$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\beta(\mu_{id})\beta'}$を満たすような任意のコンテキスト$K$と、$(t, t') \in T_{\Bullet}$を満たす任意の$t, t'$について、\\
$(\rho \CPSTh{e}\ \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{K[\Lam{t_1}{t_1}]}}\ t')\in R_{\tau}$が成り立つ。\\
ここで、(C)を示すために、\\
補題\ref{IdkContext}より以下のコンテキストが$(\Lam{v_0}{\Lam{t_0}{K[]}}, \Lam{v_0}{\Lam{t_0}{K[]}})\in  K^{kk'}_{\beta(\mu_{id})\beta'}$を満たす。\\
$\Lam{v_0}{\Lam{t_0}{K[f]}}\ =\ \Lam{v_0}{\Lam{t_0}{\Idk\ v_0\ (f\ t_0)}}$\\
\\
また$(t, t') \in T_{\Bullet}$より$t=t'=\Idt$となる。\\
$(\rho \CPSTh{e}\ \LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ t_0}}\ \Idt, \rho \CPSTh{e} \LamP{v_0}{\Lam{t_0}{\Idk\ v_0\ t_0}}\ \Idt)\in R_{\tau}$より示せた。


\end{document}

 
