module test3 where

open import Data.Nat
open import Data.Bool using (true; false)  renaming (Bool to ğ”¹)
open import Data.Empty
open import Data.Product
open import Function
open import Relation.Nullary
open import Data.Unit using (âŠ¤; tt)
open import Relation.Binary.PropositionalEquality

infixr 5 _â‡’_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_
-- type 
mutual
  data typ : Set where
    Nat : typ
    Tbool : typ
    _â‡’_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_ : typ â†’ typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ typ
  
  data trail : Set where
    âˆ™ : trail
    _â‡’_,_ : typ â†’ typ â†’ trail â†’ trail


compatible : trail â†’ trail â†’ trail â†’ Set
compatible âˆ™ Âµâ‚‚ Âµâ‚ƒ = Âµâ‚‚ â‰¡ Âµâ‚ƒ
compatible (Ï„â‚ â‡’ Ï„â‚' , Âµâ‚) âˆ™ Âµâ‚ƒ = (Ï„â‚ â‡’ Ï„â‚' , Âµâ‚) â‰¡ Âµâ‚ƒ
compatible (Ï„â‚ â‡’ Ï„â‚' , Âµâ‚) (Ï„â‚‚ â‡’ Ï„â‚‚' , Âµâ‚‚) âˆ™ = âŠ¥
compatible (Ï„â‚ â‡’ Ï„â‚' , Âµâ‚) (Ï„â‚‚ â‡’ Ï„â‚‚' , Âµâ‚‚) (Ï„â‚ƒ â‡’ Ï„â‚ƒ' , Âµâ‚ƒ) =
           (Ï„â‚ â‰¡ Ï„â‚ƒ) Ã— (Ï„â‚' â‰¡ Ï„â‚ƒ') Ã— (compatible (Ï„â‚‚ â‡’ Ï„â‚‚' , Âµâ‚‚) Âµâ‚ƒ Âµâ‚)

is-id-trail : typ â†’ typ â†’ trail â†’ Set
is-id-trail Ï„ Ï„' âˆ™ = Ï„ â‰¡ Ï„'
is-id-trail Ï„ Ï„' (Ï„â‚ â‡’ Ï„â‚' , Âµ) = (Ï„ â‰¡ Ï„â‚) Ã— (Ï„' â‰¡ Ï„â‚') Ã— (Âµ â‰¡ âˆ™)



-- source term
mutual
  data value[_]_ (var : typ â†’ Set) : typ â†’ Set where
    Var : {Ï„â‚ : typ} â†’ var Ï„â‚ â†’ value[ var ] Ï„â‚
    Num : (n : â„•) â†’ value[ var ] Nat
    -- Bol : (b : ğ”¹) â†’ value[ var ] Tbool
    Fun : (Ï„â‚ Ï„â‚‚ {Î± Î²} : typ){Î¼Î± Î¼Î² : trail} â†’
          (eâ‚ : var Ï„â‚‚ â†’ term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²)
          â†’ value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²)

  data term[_]_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_ (var : typ â†’ Set) : typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ Set where
    Val : {Ï„â‚ Î± : typ}{Î¼Î± : trail} â†’ value[ var ] Ï„â‚ â†’  term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î± âŸ©, Î±
    App : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
          (eâ‚ : term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ,âŸ¨ Î¼Î³ âŸ©, Î³ ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ) â†’
          (eâ‚‚ : term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³) â†’
          term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ
    -- Plus : {Ï„â‚ Ï„â‚‚ Î² Î³ Ïƒ : typ} â†’
    --       (eâ‚ : term[ var ] Nat , Î³ , Ïƒ) â†’ (eâ‚‚ : term[ var ] Nat , Î² , Î³) â†’
    --       term[ var ] Nat , Î² , Ïƒ
    -- Equal : {Ï„â‚ Ï„â‚‚ Î² Î³ Ïƒ : typ} â†’
    --       (eâ‚ : term[ var ] Nat , Î³ , Ïƒ) â†’ (eâ‚‚ : term[ var ] Nat , Î² , Î³) â†’
    --       term[ var ] Tbool , Î² , Ïƒ
    Control : {Ï„ Î± Î² Î³ Î³' tâ‚ tâ‚‚ : typ}{Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² : trail}  â†’
             (is-id-trail Î³ Î³' Î¼áµ¢) â†’
             (compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€) â†’
             (compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
             (e : var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±) â†’ term[ var ] Î³ ,âŸ¨ Î¼áµ¢ âŸ©, Î³' ,âŸ¨ âˆ™ âŸ©, Î²) â†’
             term[ var ] Ï„ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²
    Prompt : {Ï„ Î± Î² Î²' : typ}{Î¼áµ¢ Î¼Î± : trail} â†’
             (is-id-trail Î² Î²' Î¼áµ¢) â†’
             (e : term[ var ] Î² ,âŸ¨ Î¼áµ¢ âŸ©, Î²' ,âŸ¨ âˆ™ âŸ©, Ï„) â†’
             term[ var ] Ï„ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î± âŸ©, Î±
mutual
 âŸ¦_âŸ§Ï„ : typ â†’ Set
 âŸ¦ Nat âŸ§Ï„ = â„•
 âŸ¦ Tbool âŸ§Ï„ = ğ”¹
 âŸ¦ Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ ÂµÎ± âŸ©, Î± ,âŸ¨ ÂµÎ² âŸ©, Î² âŸ§Ï„ = âŸ¦ Ï„â‚‚ âŸ§Ï„ â†’ ( âŸ¦ Ï„â‚ âŸ§Ï„ â†’ âŸ¦ ÂµÎ± âŸ§Âµ â†’ âŸ¦ Î± âŸ§Ï„) â†’ âŸ¦ ÂµÎ² âŸ§Âµ â†’ âŸ¦ Î² âŸ§Ï„

 âŸ¦_âŸ§Âµ : trail â†’ Set
 âŸ¦ âˆ™ âŸ§Âµ = âŠ¤
 âŸ¦ Ï„ â‡’ Ï„' , Âµ âŸ§Âµ = âŸ¦ Ï„ âŸ§Ï„ â†’ âŸ¦ Âµ âŸ§Âµ â†’ âŸ¦ Ï„' âŸ§Ï„

cons-trail : {Ï„â‚ Ï„â‚‚ : typ}{Âµ ÂµÎ± ÂµÎ² : trail} â†’ compatible (Ï„â‚ â‡’ Ï„â‚‚ , Âµ) ÂµÎ± ÂµÎ²
            â†’ âŸ¦ Ï„â‚ â‡’ Ï„â‚‚ , Âµ âŸ§Âµ  â†’ âŸ¦ ÂµÎ± âŸ§Âµ â†’ âŸ¦ ÂµÎ² âŸ§Âµ
cons-trail {ÂµÎ± = âˆ™} refl k tt = k
cons-trail {ÂµÎ± = xâ‚ƒ â‡’ xâ‚„ , ÂµÎ±} {xâ‚ â‡’ xâ‚… , ÂµÎ²} (refl , refl , snd) k k' = Î» v t' â†’ k v (cons-trail snd k' t')


append-trail : {ÂµÎ± ÂµÎ² ÂµÎ³ : trail} â†’ compatible ÂµÎ± ÂµÎ² ÂµÎ³ â†’  âŸ¦ ÂµÎ± âŸ§Âµ â†’ âŸ¦ ÂµÎ² âŸ§Âµ â†’ âŸ¦ ÂµÎ³ âŸ§Âµ
append-trail {âˆ™} refl tt t = t
append-trail {xâ‚ƒ â‡’ xâ‚„ , ÂµÎ±} {âˆ™} refl k t = k
append-trail {xâ‚ƒ â‡’ xâ‚„ , ÂµÎ±} {xâ‚… â‡’ xâ‚† , ÂµÎ²} x k t = cons-trail x k t


idk : {Ï„â‚ Ï„â‚‚ : typ}{Âµ : trail} â†’ is-id-trail Ï„â‚ Ï„â‚‚ Âµ â†’ âŸ¦ Ï„â‚ âŸ§Ï„ â†’ âŸ¦ Âµ âŸ§Âµ â†’ âŸ¦ Ï„â‚‚ âŸ§Ï„
idk {Âµ = âˆ™} refl v tt = v
idk {Âµ = xâ‚ƒ â‡’ xâ‚„ , .âˆ™} (refl , refl , refl) v k = k v tt

idt = âˆ™

-- mutual
--   âŸ¦_âŸ§v : {Ï„ : typ} â†’  value[ âŸ¦_âŸ§Ï„ ] Ï„ â†’  âŸ¦ Ï„ âŸ§Ï„
--   âŸ¦ Var x âŸ§v = x
--   âŸ¦ Num n âŸ§v = n
--   âŸ¦ Fun Ï„â‚ Ï„â‚‚ eâ‚ âŸ§v = Î» v  â†’ âŸ¦ eâ‚ v âŸ§




--   âŸ¦_âŸ§ : {Ï„ Î± Î² : typ}{ÂµÎ± ÂµÎ² : trail} â†’  term[ âŸ¦_âŸ§Ï„ ] Ï„ ,âŸ¨ ÂµÎ± âŸ©, Î± ,âŸ¨ ÂµÎ² âŸ©, Î²
--            â†’ ( âŸ¦ Ï„ âŸ§Ï„ â†’  âŸ¦ ÂµÎ± âŸ§Âµ â†’ âŸ¦ Î± âŸ§Ï„ ) â†’ âŸ¦ ÂµÎ² âŸ§Âµ â†’ âŸ¦ Î² âŸ§Ï„
--   âŸ¦ Val v âŸ§ k t = {!âŸ¦ v âŸ§v!}
--   âŸ¦ App eâ‚ eâ‚‚ âŸ§ k t = âŸ¦ eâ‚ âŸ§ (Î» x â†’ âŸ¦ eâ‚‚ âŸ§ (Î» y â†’ x y k )) t
--   âŸ¦ Control x xâ‚‚ xâ‚ƒ e âŸ§ k t = âŸ¦ e (Î» v k' t' â†’ k v (append-trail xâ‚ƒ t (cons-trail xâ‚‚ k' t'))) âŸ§ (idk x) tt 
--   âŸ¦ Prompt _ _ Î² Î²' Î¼áµ¢ _ x e âŸ§ k t = k (âŸ¦ e âŸ§ (idk x) tt) t
  
mutual
  data SubstVal {var : typ â†’ Set} : {Ï„â‚ Ï„â‚‚ : typ} â†’
                (var Ï„â‚ â†’ value[ var ] Ï„â‚‚) â†’
                value[ var ] Ï„â‚ â†’
                value[ var ] Ï„â‚‚ â†’ Set where
   -- (Î»x.x)[v] â†’ v                
    sVar= : {Ï„â‚ : typ} {v : value[ var ] Ï„â‚} â†’
            SubstVal (Î» x â†’ Var x) v v
   -- (Î»_.x)[v] â†’ x
    sVarâ‰  : {Ï„â‚ Ï„â‚‚ : typ} {v : value[ var ] Ï„â‚‚} {x : var Ï„â‚} â†’
            SubstVal (Î» _ â†’ Var x) v (Var x)
   -- (Î»_.n)[v] â†’ n
    sNum  : {Ï„â‚ : typ} {v : value[ var ] Ï„â‚} {n : â„•} â†’
            SubstVal (Î» _ â†’ Num n) v (Num n)
   -- (Î»y.Î»x.ey)[v] â†’ Î»x.eâ€²
    sFun  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² : typ}{Î¼Î± Î¼Î² : trail} â†’
            {eâ‚ : var Ï„â‚ â†’ var Ï„ â†’ term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²} â†’
            {v : value[ var ] Ï„â‚} â†’
            {eâ‚â€² : var Ï„ â†’ term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²} â†’
            ((x : var Ï„) â†’ Subst (Î» y â†’ (eâ‚ y) x) v (eâ‚â€² x)) â†’
            SubstVal (Î» y â†’ Fun Ï„â‚‚ Ï„ (eâ‚ y)) v (Fun Ï„â‚‚ Ï„ eâ‚â€²)
            -- SubstVal (Î» y â†’ Fun (eâ‚ y))
            --          v
            --          (Fun eâ‚â€²)
    
  data Subst {var : typ â†’ Set} : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ : typ}{Î¼Î± Î¼Î² : trail} â†’
             (var Ï„â‚ â†’ term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚„) â†’
             value[ var ] Ï„â‚ â†’
             term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚„ â†’ Set where
             
     sVal  : {Ï„ Ï„â‚  : typ}{Î¼Î± Î¼Î² : trail} â†’
             {vâ‚ : var Ï„ â†’ value[ var ] Ï„â‚} â†’
             {v : value[ var ] Ï„} â†’
             {vâ‚â€² : value[ var ] Ï„â‚} â†’
             SubstVal vâ‚ v vâ‚â€² â†’
             Subst {Ï„â‚ƒ = Ï„â‚}{Î¼Î± = Î¼Î±}(Î» y â†’ Val (vâ‚ y)) v (Val vâ‚â€²)

             
     sApp  : {Ï„ Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
             {eâ‚ : var Ï„ â†’ term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ,âŸ¨ Î¼Î³ âŸ©, Î³ ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ}
             {eâ‚‚ : var Ï„ â†’ term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³}
             {v : value[ var ] Ï„}
             {eâ‚â€² : term[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ,âŸ¨ Î¼Î³ âŸ©, Î³ ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ}
             {eâ‚‚â€² : term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³} â†’
             Subst eâ‚ v eâ‚â€² â†’ Subst eâ‚‚ v eâ‚‚â€² â†’
             Subst (Î» y â†’ App (eâ‚ y) (eâ‚‚ y))
                   v
                   (App eâ‚â€² eâ‚‚â€²)

     sCon : {Ï„ tâ‚ tâ‚‚ Ï„â‚ƒ Î± Î² Î³ Î³' : typ}{Î¼â‚€ Î¼â‚ Î¼â‚‚ Î¼áµ¢ Î¼Î± Î¼Î² : trail} â†’
            {eâ‚ : var Ï„â‚ƒ â†’
                  var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±) â†’
                  term[ var ] Î³ ,âŸ¨ Î¼áµ¢ âŸ©, Î³' ,âŸ¨ âˆ™ âŸ©, Î²} â†’
            {v  : value[ var ] Ï„â‚ƒ} â†’
            {eâ‚â€² : var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±) â†’
                  term[ var ] Î³ ,âŸ¨ Î¼áµ¢ âŸ©, Î³' ,âŸ¨ âˆ™ âŸ©, Î²} â†’
            {x : is-id-trail Î³ Î³' Î¼áµ¢} â†’
            {xâ‚‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€} â†’
            {xâ‚ƒ : compatible Î¼Î² Î¼â‚€ Î¼Î±} â†’
            ((k : var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±)) â†’
                 Subst (Î» y â†’ (eâ‚ y) k) v ((eâ‚â€² k))) â†’
            Subst (Î» y â†’ Control x xâ‚‚ xâ‚ƒ (eâ‚ y))
                  v
                  (Control x xâ‚‚ xâ‚ƒ eâ‚â€²)


     sPro : {Ï„ Î² Î²' Î³ Ï„â‚ƒ : typ}{Î¼áµ¢ Î¼Î± : trail} â†’
            {eâ‚ : var Ï„ â†’ term[ var ] Î² ,âŸ¨ Î¼áµ¢ âŸ©, Î²' ,âŸ¨ âˆ™ âŸ©, Î³} â†’
            {v : value[ var ] Ï„} â†’
            {eâ‚â€² : term[ var ] Î² ,âŸ¨ Î¼áµ¢ âŸ©, Î²' ,âŸ¨ âˆ™ âŸ©, Î³} â†’
            {x : is-id-trail Î² Î²' Î¼áµ¢} â†’
            Subst eâ‚ v eâ‚â€² â†’
            Subst {Ï„â‚ƒ = Ï„â‚ƒ}{Î¼Î± = Î¼Î±} (Î» y â†’ Prompt x (eâ‚ y)) v
                  (Prompt  x eâ‚â€²)


  --frame
  data frame[_,_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_]_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_ (var : typ â†’ Set)
       : typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ Set where
    Appâ‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
           (eâ‚‚ : term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³) â†’
           frame[ var , (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ,âŸ¨ Î¼Î³ âŸ©, Î³ ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ ]
                  Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ

    Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
           (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²)) â†’
           frame[ var , Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³ ]
                  Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î³ âŸ©, Î³

    Pro  : {Ï„ Î± Î² Î²' : typ}{Î¼áµ¢ Î¼Î± : trail} â†’
           (is-id-trail Î² Î²' Î¼áµ¢) â†’
           frame[ var , Î² ,âŸ¨ Î¼áµ¢ âŸ©, Î²' ,âŸ¨ âˆ™ âŸ©, Ï„ ] Ï„ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î± âŸ©, Î±

  frame-plug : {var : typ â†’ Set}
               {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
               frame[ var , Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚„ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚… ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚† â†’
               term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚„ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚…  â†’
               term[ var ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚†
  frame-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
  frame-plug {Î¼Î² = Î¼Î²}(Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚

  
  frame-plug {Ï„â‚ = Ï„â‚}{Ï„â‚‚ = Ï„â‚‚}{Ï„â‚ƒ = Ï„â‚ƒ}{Ï„â‚„ = Ï„â‚„}{Î¼Î± = Î¼Î±}{Î¼Î³ = Î¼Î³} (Pro x) eâ‚ =
             Prompt x eâ‚

                 
                 
       
  --frame
  data pframe[_,_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_]_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_ (var : typ â†’ Set)
       : typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ Set where
    Appâ‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
           (eâ‚‚ : term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³) â†’
           pframe[ var , (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ,âŸ¨ Î¼Î³ âŸ©, Î³ ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ ]
                   Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Ïƒ âŸ©, Ïƒ

    Appâ‚‚ : {Ï„â‚ Ï„â‚‚ Î± Î² Î³ Ïƒ : typ}{Î¼Î± Î¼Î² Î¼Î³ : trail} â†’
           (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²)) â†’
           pframe[ var , Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Î² ,âŸ¨ Î¼Î³ âŸ©, Î³ ]
                   Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î³ âŸ©, Î³


  pframe-plug : {var : typ â†’ Set}
               {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
               pframe[ var , Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚„ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚… ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚† â†’
               term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚„ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚…  â†’
               term[ var ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚†
 
  pframe-plug (Appâ‚ eâ‚‚) eâ‚ = App eâ‚ eâ‚‚
  pframe-plug {Î¼Î² = Î¼Î²}(Appâ‚‚ vâ‚) eâ‚‚ = App (Val vâ‚) eâ‚‚

  data same-pframe {var : typ â†’ Set}{Ï„â‚‡ Ï„â‚†  : typ}{Î¼Î² Î¼Ïƒ : trail} :
                   {Ï„ Ï„â‚… Ï„â‚ Ï„â‚ƒ Ï„' Ï„â‚…' : typ}{Î¼Î± Î¼Î±' Î¼Î³ : trail} â†’
         pframe[ var , Ï„ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚… ,âŸ¨ Î¼Î² âŸ©, Ï„â‚† ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚†  â†’
         pframe[ var , Ï„' ,âŸ¨ Î¼Î±' âŸ©, Ï„â‚…' ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚‡ ] Ï„â‚ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚‡  â†’
         Set where
   Appâ‚ : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… : typ}{Î¼â‚„ Î¼â‚… Î¼Î³ : trail} â†’
          (eâ‚‚ : term[ var ] Ï„â‚‚ ,âŸ¨ Î¼â‚„ âŸ©, Ï„â‚„ ,âŸ¨ Î¼â‚… âŸ©, Ï„â‚…) â†’
          same-pframe {Ï„â‚ = Ï„â‚}{Ï„â‚ƒ = Ï„â‚ƒ}{Î¼Î³ = Î¼Î³} (Appâ‚ eâ‚‚) (Appâ‚ eâ‚‚)
   Appâ‚‚ : {Î± Î² Ï„â‚ Ï„â‚‚ Ïƒ : typ}{Î¼Î± Î¼Î² : trail} â†’
          (vâ‚ : value[ var ] (Ï„â‚‚ â‡’ Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î²) ) â†’
          same-pframe  (Appâ‚‚ {Ïƒ = Ïƒ} vâ‚) (Appâ‚‚ {Ïƒ = Ïƒ} vâ‚)

  -- pure context
  data pcontext[_,_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_]_,âŸ¨_âŸ©,_,âŸ¨_âŸ©,_ (var : typ â†’ Set)
       : typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ typ â†’ trail â†’ typ â†’ trail â†’ typ â†’ Set where
   Hole : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail} â†’
          pcontext[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ
   Frame : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† Ï„â‚‡ : typ}{Î¼Î± Î¼Î³ Î¼Ïƒ Î¼â‚ Î¼' : trail} â†’
           (f : pframe[ var , Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚… ,âŸ¨ Î¼â‚ âŸ©, Ï„â‚ƒ ] Ï„â‚† ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚‡ ,âŸ¨ Î¼â‚ âŸ©, Ï„â‚ƒ ) â†’
           (e : pcontext[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼' âŸ©, Ï„â‚ƒ ] Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚… ,âŸ¨ Î¼â‚ âŸ©, Ï„â‚ƒ ) â†’
           pcontext[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼' âŸ©, Ï„â‚ƒ ] Ï„â‚† ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚‡ ,âŸ¨ Î¼â‚ âŸ©, Ï„â‚ƒ

  pcontext-plug : {var : typ â†’ Set}
                  ({Ï„â‚} Ï„â‚‚ {Ï„â‚ƒ Ï„â‚„ Ï„â‚…} : typ){Î¼Î± Î¼Î² Î¼Î³ Î¼' : trail} â†’
                  pcontext[ var , Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚„ ,âŸ¨ Î¼' âŸ©, Ï„â‚… ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚… â†’
                  term[ var ] Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚„ ,âŸ¨ Î¼' âŸ©, Ï„â‚… â†’
                  term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚ƒ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚…
  pcontext-plug Ï„â‚‚ Hole eâ‚ = eâ‚
  pcontext-plug Ï„â‚‚ (Frame f p) eâ‚ = pframe-plug f (pcontext-plug Ï„â‚‚ p eâ‚)


  data same-pcontext {var : typ â†’ Set} {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ} :
                     {Ï„â‚„ Ï„â‚† Ï„â‚‡ Ï„' : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼' Î¼â‚‚ Î¼â‚ƒ  : trail} â†’
                     pcontext[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼â‚ƒ âŸ©, Ï„â‚ƒ ] Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚‡ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ  â†’
                     pcontext[ var , Ï„â‚ ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ ] Ï„â‚† ,âŸ¨ Î¼' âŸ©, Ï„' ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚   â†’
                     Set where
       Hole  : {Î¼Î± Î¼Î² Î¼' : trail} â†’ same-pcontext {Î¼Î± = Î¼Î±}{Î¼Î² = Î¼Î²}{Î¼' = Î¼'}  Hole Hole
       Frame : {Ï„â‚„  Ï„â‚† Ï„â‚‡ Ï„' Ï„â‚ˆ Ï„â‚‰  : typ}{Î¼â‚‚ Î¼â‚ƒ Î¼â‚‡ Î¼Î± Î¼Î² Î¼Î³ Î¼' : trail} â†’
               {fâ‚ : pframe[ var , Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚‡ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ ] Ï„â‚‰ ,âŸ¨ Î¼â‚‡ âŸ©, Ï„â‚ˆ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ } â†’
               {fâ‚‚ : pframe[ var , Ï„â‚† ,âŸ¨ Î¼' âŸ©, Ï„' ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ ] Ï„â‚‰ ,âŸ¨ Î¼â‚‡ âŸ©, Ï„â‚ˆ ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ } â†’
               same-pframe  fâ‚ fâ‚‚ â†’
               {pâ‚ : pcontext[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼â‚ƒ âŸ©, Ï„â‚ƒ ] Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚‡ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ } â†’
               {pâ‚‚ : pcontext[ var , Ï„â‚ ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ ] Ï„â‚† ,âŸ¨ Î¼' âŸ©, Ï„' ,âŸ¨ Î¼â‚‚ âŸ©, Ï„â‚‚ } â†’
               same-pcontext pâ‚ pâ‚‚ â†’
               same-pcontext (Frame fâ‚ pâ‚) (Frame fâ‚‚ pâ‚‚)
 
               
    -- Hole  : same-pcontext Hole Hole
    -- Frame : {Ï„â‚„ Ï„â‚… Ï„â‚† Ï„â‚‡ : typ} â†’
    --         {fâ‚ : pframe[ var , Ï„â‚„ cps[ Ï„â‚… , Ï„â‚ƒ ]] Ï„â‚†
    --                     cps[ Ï„â‚‡ , Ï„â‚ƒ ]} â†’
    --         {fâ‚‚ : pframe[ var , Ï„â‚„ cps[ Ï„â‚… , Ï„â‚‚ ]] Ï„â‚†
    --                     cps[ Ï„â‚‡ , Ï„â‚‚ ]} â†’
    --         same-pframe fâ‚ fâ‚‚ â†’
    --         {pâ‚ : pcontext[ var , Ï„â‚ cps[ Ï„â‚‚ , Ï„â‚ƒ ]] Ï„â‚„
    --                       cps[ Ï„â‚… , Ï„â‚ƒ ]} â†’
    --         {pâ‚‚ : pcontext[ var , Ï„â‚ cps[ Ï„â‚‚ , Ï„â‚‚ ]] Ï„â‚„
    --                       cps[ Ï„â‚… , Ï„â‚‚ ]} â†’
    --         same-pcontext pâ‚ pâ‚‚ â†’
    --         same-pcontext (Frame fâ‚ pâ‚) (Frame fâ‚‚ pâ‚‚)
          
  -- reduction rules
  data Reduce {var : typ â†’ Set} :
              {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail} â†’
              term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ â†’
              term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ â†’ Set where
    RBeta   : {Ï„ Ï„â‚ Ï„â‚‚ Ï„â‚ƒ : typ}{Î¼Î± Î¼Î² : trail} â†’
              {eâ‚ : var Ï„ â†’ term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ} â†’
              {vâ‚‚ : value[ var ] Ï„} â†’
              {eâ‚â€² : term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ} â†’
              Subst eâ‚ vâ‚‚ eâ‚â€² â†’
              Reduce (App (Val (Fun Ï„â‚ Ï„ eâ‚)) (Val vâ‚‚)) eâ‚â€²

              
    RFrame  : {Ï„â‚ Ï„â‚‚ Ï„â‚ƒ Ï„â‚„ Ï„â‚… Ï„â‚† : typ}{Î¼Î± Î¼Î² Î¼Î³ Î¼Ïƒ : trail} â†’
              {eâ‚ : term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ} â†’
              {eâ‚‚ : term[ var ] Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ} â†’
              (f : frame[ var , Ï„â‚ ,âŸ¨ Î¼Î± âŸ©, Ï„â‚‚ ,âŸ¨ Î¼Î² âŸ©, Ï„â‚ƒ ]
                        Ï„â‚„ ,âŸ¨ Î¼Î³ âŸ©, Ï„â‚… ,âŸ¨ Î¼Ïƒ âŸ©, Ï„â‚†) â†’
              Reduce eâ‚ eâ‚‚ â†’
              Reduce (frame-plug f eâ‚) (frame-plug f eâ‚‚)

    RPrompt : {Ï„â‚ Ï„â‚‚ Î² : typ}{Î¼Î± Î¼Î² : trail} â†’
              {vâ‚ : value[ var ] Î²} â†’
              Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = âˆ™}(Prompt refl (Val vâ‚)) (Val vâ‚)
 
                  
    RControl : {Ï„ Î± Î² Î³ Î³' tâ‚ tâ‚‚ Ï„â‚„ Ï„â‚ Ï„â‚‚ : typ}{Î¼â‚€ Î¼â‚  Î¼áµ¢ Î¼Î± Î¼Î² Î¼â‚‚ Î¼â‚ƒ Î¼â‚„ Î¼â‚… : trail} â†’
              (pâ‚ : pcontext[ var , Ï„ ,âŸ¨ Î¼Î± âŸ©, Î± ,âŸ¨ Î¼Î² âŸ©, Î² ]
                             Î³ ,âŸ¨ Î¼áµ¢ âŸ©, Î³' ,âŸ¨ âˆ™ âŸ©, Î² ) â†’
              (pâ‚‚ : pcontext[ var , Ï„ ,âŸ¨ Î¼â‚‚ âŸ©, Î± ,âŸ¨ Î¼â‚‚ âŸ©, Î± ]
                             tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î± ) â†’ -- Î¼áµ¢ã¨Î³ã‚’æƒãˆãªãã‚ƒãªã‚‰ã‚“
              (xâ‚ : is-id-trail Î³ Î³' Î¼áµ¢) â†’
              (xâ‚‚ : compatible (tâ‚ â‡’ tâ‚‚ , Î¼â‚) Î¼â‚‚ Î¼â‚€) â†’
              (xâ‚ƒ : compatible Î¼Î² Î¼â‚€ Î¼Î±) â†’
              same-pcontext pâ‚ pâ‚‚ â†’
              (e : var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±) â†’ term[ var ] Î³ ,âŸ¨ Î¼áµ¢ âŸ©, Î³' ,âŸ¨ âˆ™ âŸ©, Î²) â†’
              Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±}(Prompt xâ‚
                     (pcontext-plug Ï„ pâ‚ (Control xâ‚ xâ‚‚ xâ‚ƒ e)))
                     (Prompt xâ‚ (App (Val
                     (Fun Î³ (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±) e))
                     (Val (Fun tâ‚ Ï„ Î» x â†’ pcontext-plug Ï„ pâ‚‚ (Val (Var x))))))
    --           -- tâ‚‚ã¯Î³'ã§ã€Î¼â‚ã¯Î¼áµ¢ã«ã—ãªã„ã¨ã„ã‘ãªããªã£ãŸ (æœ¬æ¥ã®eã¯ var (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼â‚‚ âŸ©, Î±))
    --           Reduce {Ï„â‚‚ = Ï„â‚‚}{Î¼Î± = Î¼Î±}(Prompt xâ‚
    --                  (pcontext-plug Ï„ pâ‚ (Control xâ‚ xâ‚‚ xâ‚ƒ e)))
    --                  (Prompt xâ‚ (App (Val
    --                  (Fun Î³ (Ï„ â‡’ tâ‚ ,âŸ¨ Î¼â‚ âŸ©, tâ‚‚ ,âŸ¨ Î¼Î² âŸ©, Î±) e))
    --                  (Val (Fun tâ‚ Ï„ Î» x â†’ pcontext-plug Ï„ pâ‚‚ (Val (Var x))))))
